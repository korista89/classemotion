<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ê°ì • ëª¨ë‹ˆí„°ë§ Â· Classroom v7.6</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
  :root{
    --bg:#f8fafc;--panel:#ffffff;--text:#0f172a;--sub:#475569;
    --brand:#4f46e5;--brand-weak:#eef2ff;--accent:#22c55e;--warn:#f97316;--err:#ef4444;
    --border:#e5e7eb;--chip:#f1f5f9;--muted:#94a3b8;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;font-size:15px;line-height:1.45}
  .wrap{max-width:1200px;margin:0 auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .space{height:8px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;min-height:40px;font-size:15px}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff;color:#0f172a}
  .btn.warn{background:var(--warn);color:#fff;border-color:transparent}
  .btn.danger{background:var(--err);color:#fff;border-color:transparent}
  .btn:disabled{background:#e5e7eb;cursor:not-allowed;color:#9ca3af}
  .tabs{display:flex;gap:8px;overflow-x:auto;margin-bottom:12px;scrollbar-width:none}
  .tabs::-webkit-scrollbar{display:none}
  .tab{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:800;white-space:nowrap}
  .tab.active{background:var(--brand);color:#fff;border-color:transparent}
  .admin-only,.student-only{display:none!important}
  body.role-admin .admin-only{display:flex!important}
  body.role-student .student-only{display:flex!important}
  .tab.admin-only,.tab.student-only{display:none!important}
  body.role-admin .tab.admin-only{display:inline-flex!important}
  body.role-student .tab.student-only{display:inline-flex!important}
  input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;min-height:42px;background:#fff}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;position:sticky;top:0;background:transparent;z-index:5}
  .brand{display:flex;align-items:center;gap:12px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-weight:700}
  .scroller{display:flex;gap:12px;overflow-x:auto;padding:6px 2px;-webkit-overflow-scrolling:touch;scrollbar-width:none}
  .scroller::-webkit-scrollbar{display:none}
  .stu{flex:0 0 160px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:12px;text-align:center;cursor:pointer;transition:.2s ease}
  .stu:hover{transform:translateY(-1px)}
  .stu.selected{border-color:var(--brand);box-shadow:0 0 0 3px rgba(79,70,229,.25)}
  .stu.completed{background:rgba(34,197,94,.08);border-color:var(--accent)}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#e5e7eb;border:2px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.06);font-size:40px;line-height:60px;text-align:center;background-size:cover;background-position:center}
  .emoBtn{display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;cursor:pointer}
  .emoBtn.active{border-color:var(--brand);background:var(--brand-weak)}
  .context{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:13px;cursor:pointer;text-align:center;user-select:none}
  .chip.selected{background:var(--brand);color:#fff;border-color:transparent}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #e2e8f0;padding:8px;text-align:center;font-size:14px}
  th{background:#f8fafc}
  .hide{display:none !important;} /* ê°•ì œ ìˆ¨ê¹€ */
  .chart-container{position:relative;height:420px;width:100%;margin-top:10px}
  .muted{color:var(--muted)}
  .loader{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:10px;font-weight:bold;color:var(--brand)}
  .loader.show{display:flex}
  .loader-spinner{width:48px;height:48px;border:5px solid #f3f3f3;border-top:5px solid var(--brand);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:120}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:18px;border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.25);max-height:90vh;overflow-y:auto}
  .modal .box h3{margin:0 0 8px}
  .emoji-picker{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin:10px 0}
  .emoji-choice{font-size:32px;text-align:center;padding:10px;border-radius:12px;cursor:pointer;border:2px solid transparent}
  .emoji-choice.selected{border-color:var(--brand);background:var(--brand-weak)}
  .tip{background:#fff;border:1px dashed var(--border);border-radius:12px;padding:10px;color:var(--sub)}
  /* v7.6: í•™ìƒë“±ë¡ íƒ­ ì„¸ë¡œí˜• ë ˆì´ì•„ì›ƒ ê°•ì œ */
  #tab-new .row, #tab-new label, #tab-new .context, #tab-new .emoji-picker {width:100%}
  #tab-new .row{align-items:flex-start}
  #tab-new .avatar{margin-top:24px}
  #tab-new .context{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))}
  #tab-new{overflow:hidden}
  /* ì»¨í…Œì´ë„ˆ í­ ë„˜ì–´ê°€ëŠ” ìš”ì†Œ ë°©ì§€ */
  [role="tabpanel"]{max-width:100%;overflow-x:hidden}
  @media(max-width:640px){.stu{flex:0 0 140px}.emoji-picker{grid-template-columns:repeat(4,1fr)}#tab-new .context{grid-template-columns:repeat(2,1fr)}}
  @media print{.no-print{display:none!important}body{background:#fff}.card{border:0;box-shadow:none}#reportBox{padding:0}@page{size:A4;margin:12mm}}
</style>
</head>
<body>
<!-- ë¡œë” -->
<div id="loader" class="loader" aria-live="polite"><div class="loader-spinner" role="progressbar" aria-label="ì²˜ë¦¬ ì¤‘"></div><div id="loader-msg"></div></div>

<div class="wrap">
  <!-- ìƒë‹¨ë°” -->
  <div class="topbar card no-print" aria-label="ìƒë‹¨ ë„êµ¬ ë§‰ëŒ€">
    <div class="brand">
      <div style="font-size:30px">ğŸ“Š</div>
      <div>
        <div style="font-weight:900;font-size:20px">ê°ì • ëª¨ë‹ˆí„°ë§ Â· Classroom</div>
        <div class="muted" style="font-size:12px">v7.6 Â· UI Stabilized</div>
      </div>
    </div>
    <div class="row">
      <button id="manualSync" class="btn" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <button id="openSheet" class="btn admin-only" title="ì‹œíŠ¸ ë³´ê¸°">ğŸ“„ ì‹œíŠ¸</button>
      <button id="gear" class="btn admin-only" title="ì—°ë™ ì„¤ì •">âš™ï¸ ì„¤ì •</button>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ -->
  <section id="login" class="card" aria-label="ë¡œê·¸ì¸ ì„¹ì…˜">
    <h2 style="margin-top:0">ğŸ” ë¡œê·¸ì¸</h2>
    <div class="row" role="form" aria-label="ë¡œê·¸ì¸ í¼">
      <label style="flex:1">
        <span class="muted">ì•„ì´ë””</span>
        <select id="userSelect" aria-label="ì•„ì´ë”” ì„ íƒ"><option value="admin" selected>admin</option></select>
      </label>
      <label style="flex:1">
        <span class="muted">ë¹„ë°€ë²ˆí˜¸</span>
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" aria-label="ë¹„ë°€ë²ˆí˜¸"/>
      </label>
      <div style="display:flex;align-items:flex-end">
        <button id="btnLogin" class="btn primary">ë¡œê·¸ì¸</button>
      </div>
    </div>
    <div class="space"></div>
    <div class="row muted">ì—°ê²° ìƒíƒœ: <span id="linkStatus" class="badge">ë¯¸ì„¤ì •</span></div>
  </section>

  <!-- ì•± ë³¸ë¬¸ -->
  <section id="app" class="card hide" aria-label="ì•± ë³¸ë¬¸">
    <div class="row no-print" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <div id="who" class="badge">-</div>
      <button id="btnLogout" class="btn">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <!-- íƒ­ -->
    <div class="tabs no-print" id="tabs" role="tablist" aria-label="ê¸°ëŠ¥ íƒ­">
      <button class="tab active" data-tab="am" role="tab" aria-selected="true">ğŸ« ë“±êµ</button>
      <button class="tab" data-tab="pm" role="tab" aria-selected="false">ğŸ¡ í•˜êµ</button>
      <button class="tab student-only" data-tab="graph" role="tab" aria-selected="false">ğŸ“Š ë‚˜ì˜ ê·¸ë˜í”„</button>
      <button class="tab admin-only" data-tab="data" role="tab" aria-selected="false">ğŸ“‹ ë°ì´í„° ê´€ë¦¬</button>
      <button class="tab admin-only" data-tab="graph" role="tab" aria-selected="false">ğŸ“Š ë³´ê³ ì„œ</button>
      <button class="tab admin-only" data-tab="list" role="tab" aria-selected="false">ğŸ‘¥ í•™ìƒëª©ë¡</button>
      <button class="tab admin-only" data-tab="new" role="tab" aria-selected="false">â• í•™ìƒë“±ë¡</button>
      <button class="tab admin-only" data-tab="users" role="tab" aria-selected="false">ğŸ”‘ ì‚¬ìš©ì ê´€ë¦¬</button>
    </div>

    <!-- AM -->
    <div id="tab-am" role="tabpanel">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="amPrev" title="ì´ì „ ë‚ ì§œ">â—€</button>
        <button class="badge" id="amDateBtn" title="ë‚ ì§œ ì„ íƒ"><span id="amDate"></span></button>
        <input id="amDatePicker" class="hide" type="date" aria-label="ë“±êµ ë‚ ì§œ ì„ íƒ"/>
        <button class="btn" id="amNext" title="ë‹¤ìŒ ë‚ ì§œ">â–¶</button>
      </div>
      <div class="space"></div>
      <h3 class="admin-only" style="display:block;margin:0">í•™ìƒ ì„ íƒ</h3>
      <div id="amScroller" class="scroller admin-only" style="display:flex;"></div>
      <div id="amForm" aria-label="ë“±êµ ê°ì • ì…ë ¥">
        <h3 id="amWho" style="text-align:center;margin-top:14px"></h3>
        <div id="amEmotions" class="col"></div>
        <div id="amCtxWrap" class="hide">
          <div style="text-align:center;margin:12px 0 8px" class="muted">ë§¥ë½ ì„ íƒ(ë³µìˆ˜ ê°€ëŠ¥)</div>
          <div id="amCtx" class="context"></div>
        </div>
        <div class="row" style="margin-top:14px;justify-content:center">
          <button class="btn primary" id="amSave" style="padding:12px 32px">ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- PM -->
    <div id="tab-pm" class="hide" role="tabpanel">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="pmPrev" title="ì´ì „ ë‚ ì§œ">â—€</button>
        <button class="badge" id="pmDateBtn" title="ë‚ ì§œ ì„ íƒ"><span id="pmDate"></span></button>
        <input id="pmDatePicker" class="hide" type="date" aria-label="í•˜êµ ë‚ ì§œ ì„ íƒ"/>
        <button class="btn" id="pmNext" title="ë‹¤ìŒ ë‚ ì§œ">â–¶</button>
      </div>
      <div class="space"></div>
      <h3 class="admin-only" style="display:block;margin:0">í•™ìƒ ì„ íƒ</h3>
      <div id="pmScroller" class="scroller admin-only" style="display:flex;"></div>
      <div id="pmForm" aria-label="í•˜êµ ê°ì • ì…ë ¥">
        <h3 id="pmWho" style="text-align:center;margin-top:14px"></h3>
        <div id="pmEmotions" class="col"></div>
        <div id="pmCtxWrap" class="hide">
          <div style="text-align:center;margin:12px 0 8px" class="muted">ë§¥ë½ ì„ íƒ(ë³µìˆ˜ ê°€ëŠ¥)</div>
          <div id="pmCtx" class="context"></div>
        </div>
        <div class="row" style="margin-top:14px;justify-content:center">
          <button class="btn primary" id="pmSave" style="padding:12px 32px">ì €ì¥</button>
        </div>
      </div>
    </div>

    <!-- ë°ì´í„° ê´€ë¦¬ -->
    <div id="tab-data" class="hide admin-only" role="tabpanel">
      <div class="row">
        <select id="dataStudentSelect" aria-label="í•™ìƒ í•„í„°"></select>
        <select id="dataSlotSelect" aria-label="êµ¬ë¶„ í•„í„°">
          <option value="">ì „ì²´</option>
          <option value="morning">ë“±êµ</option>
          <option value="afternoon">í•˜êµ</option>
        </select>
        <button id="btnClear" class="btn ghost">í•„í„° ì´ˆê¸°í™”</button>
      </div>
      <table aria-label="ë°ì´í„° í‘œ">
        <thead><tr><th>ë‚ ì§œ</th><th>í•™ìƒ</th><th>êµ¬ë¶„</th><th>ì ìˆ˜</th><th>ë§¥ë½</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>

    <!-- ê·¸ë˜í”„/ë³´ê³ ì„œ -->
    <div id="tab-graph" class="hide" role="tabpanel">
      <div class="row admin-only"><select id="graphStudent" aria-label="ê·¸ë˜í”„ í•™ìƒ ì„ íƒ"></select></div>
      <div class="row">
        <label style="flex:1"><span class="muted">ì‹œì‘</span><input type="date" id="fromDate"></label>
        <label style="flex:1"><span class="muted">ì¢…ë£Œ</span><input type="date" id="toDate"></label>
        <button class="btn" id="btnGraph">ê·¸ë˜í”„ ìƒì„±</button>
        <button class="btn admin-only" id="btnPrint">ğŸ–¨ï¸ ì¸ì‡„</button>
      </div>
      <h3 id="graphTitle" style="text-align:center; margin-top:12px; min-height: 24px;"></h3>
      <div class="chart-container"><canvas id="chart" aria-label="ê°ì • ì¶”ì´ ê·¸ë˜í”„"></canvas></div>
      <div id="reportBox" class="card admin-only" style="margin-top:16px"></div>
    </div>

    <!-- í•™ìƒ ëª©ë¡ -->
    <div id="tab-list" class="hide admin-only" role="tabpanel"><h3>í•™ìƒ ëª©ë¡</h3><div id="stuList"></div></div>

    <!-- í•™ìƒ ë“±ë¡ -->
    <div id="tab-new" class="hide admin-only" role="tabpanel">
      <h3>í•™ìƒ ë“±ë¡</h3>
      <div class="tip">ì‚¬ì§„ì´ ì—†ìœ¼ë©´ ì´ëª¨ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
      <div class="space"></div>

      <div class="row">
        <label style="flex:1;min-width:240px"><span class="muted">ì´ë¦„</span><input id="newName" placeholder="í•™ìƒ ì´ë¦„"></label>
        <div id="newAvatar" class="avatar" aria-label="ì•„ë°”íƒ€ ë¯¸ë¦¬ë³´ê¸°">ğŸ‘¤</div>
      </div>
      <div class="emoji-picker" id="newEmojiPicker"></div>
      <label for="photo" class="btn" style="width:100%;text-align:center">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</label>
      <input id="photo" type="file" accept="image/*" class="hide"><div class="space"></div>

      <div class="row">
        <label style="flex:1;min-width:240px"><span class="muted">ë¡œê·¸ì¸ ì•„ì´ë””</span><input id="newUsername" placeholder="ì˜ˆ: 1-í™ê¸¸ë™"/></label>
        <label style="flex:1;min-width:240px"><span class="muted">ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸</span><input id="newPassword" placeholder="ì„ì‹œ ë¹„ë°€ë²ˆí˜¸"/></label>
      </div>

      <label>í•™ê¸‰</label><div id="chipsClass" class="context"></div>
      <label>ì„±ë³„</label><div id="chipsSex" class="context"></div>
      <label>ì§„ë‹¨</label><div id="chipsDx" class="context"></div>
      <label>ì˜ì‚¬ì†Œí†µ</label><div id="chipsComm" class="context"></div>
      <label>ê°ê° í”„ë¡œí•„</label><div id="chipsSensory" class="context"></div>
      <label>ì„ í˜¸ ê°•í™”ì œ</label><div id="chipsReinf" class="context"></div>
      <label>ì£¼ìš” ìœ ë°œìƒí™©</label><div id="chipsTrigger" class="context"></div>
      <label>ì˜ë£Œ/ì•½ë¬¼</label><div id="chipsMeds" class="context"></div>
      <div class="row" style="margin-top:8px"><input id="newParent" type="tel" placeholder="ë³´í˜¸ì ì—°ë½ì²˜" style="width:100%"/></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn primary" id="addStu">ë“±ë¡</button></div>
    </div>

    <!-- ì‚¬ìš©ì ê´€ë¦¬ -->
    <div id="tab-users" class="hide admin-only" role="tabpanel">
      <h3>ì‚¬ìš©ì ê´€ë¦¬</h3>
      <table><thead><tr><th>ì•„ì´ë””</th><th>ì—­í• </th><th>ìƒˆ ë¹„ë°€ë²ˆí˜¸</th><th>ì €ì¥</th></tr></thead><tbody id="userBody"></tbody></table>
    </div>
  </section>
</div>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="modalSettings" class="modal" role="dialog" aria-modal="true" aria-label="ì—°ë™ ì„¤ì •">
  <div class="box">
    <h3>ì—°ë™ ì„¤ì •</h3>
    <p class="muted">ë°°í¬ëœ ì›¹ì•± URLì„ ë¶™ì—¬ë„£ê³  ì €ì¥í•˜ì„¸ìš”.</p>
    <input id="syncUrlInput" placeholder="https://script.google.com/macros/s/...">
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="saveUrl" class="btn primary">ì €ì¥</button>
      <button class="btn" onclick="closeModal('#modalSettings')">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ì•ˆë‚´ ëª¨ë‹¬ -->
<div id="modalDone" class="modal" role="dialog" aria-modal="true" aria-label="ì•Œë¦¼">
  <div class="box"><h3>ì•Œë¦¼</h3><div id="doneMsg"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="doneOk" class="btn primary">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- í•™ìƒ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="modalEdit" class="modal" role="dialog" aria-modal="true" aria-label="í•™ìƒ ì •ë³´ ìˆ˜ì •">
  <div class="box">
    <h3>í•™ìƒ ì •ë³´ ìˆ˜ì •</h3>
    <div class="row"><label style="flex:1"><span class="muted">ì´ë¦„</span><input id="editName" placeholder="ì´ë¦„"></label><div id="editAvatar" class="avatar">ğŸ‘¤</div></div>
    <div class="emoji-picker" id="editEmojiPicker"></div>
    <label for="editPhoto" class="btn" style="width:100%;text-align:center">ğŸ“· ì‚¬ì§„ ì—…ë¡œë“œ</label>
    <input id="editPhoto" type="file" accept="image/*" class="hide"><div class="space"></div>
    <label>í•™ê¸‰</label><div id="editClass" class="context"></div>
    <label>ì„±ë³„</label><div id="editSex" class="context"></div>
    <label>ì§„ë‹¨</label><div id="editDx" class="context"></div>
    <label>ì˜ì‚¬ì†Œí†µ</label><div id="editComm" class="context"></div>
    <label>ê°ê° í”„ë¡œí•„</label><div id="editSensory" class="context"></div>
    <label>ì„ í˜¸ ê°•í™”ì œ</label><div id="editReinf" class="context"></div>
    <label>ì£¼ìš” ìœ ë°œìƒí™©</label><div id="editTrigger" class="context"></div>
    <label>ì˜ë£Œ/ì•½ë¬¼</label><div id="editMeds" class="context"></div>
    <div class="row" style="margin-top:8px"><input id="editParent" type="tel" placeholder="ë³´í˜¸ì ì—°ë½ì²˜"/></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn primary" id="editSave">ì €ì¥</button>
      <button class="btn" onclick="closeModal('#modalEdit')">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ -->
<div id="modalEditEmotion" class="modal" role="dialog" aria-modal="true" aria-label="ê¸°ë¡ ìˆ˜ì •">
  <div class="box">
    <h3>ê¸°ë¡ ìˆ˜ì •</h3>
    <p id="editEmotionInfo" class="muted"></p>
    <label>ê°ì • ì ìˆ˜ (0-5)</label><input id="editEmotionScore" type="number" min="0" max="5" />
    <label style="margin-top:8px">ë§¥ë½ (ì‰¼í‘œ êµ¬ë¶„)</label><input id="editEmotionContext" type="text" placeholder="ì˜ˆ: ìˆ˜ë©´ë¶€ì¡±, ë˜ë˜ê°ˆë“±"/>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="editEmotionSave" class="btn primary">ì €ì¥</button>
      <button class="btn" onclick="closeModal('#modalEditEmotion')">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== Constants & State =====
  const KEY_URL="sync_url_classroom_v7";
  let SYNC_URL=localStorage.getItem(KEY_URL)||"";
  let session={role:null,user:null};
  let students=[],emotionData={};
  let editTargetId=null, editEmotionTarget=null;
  let chartInstance=null;
  let amDate=new Date(), pmDate=new Date();

  // ===== Dictionaries =====
  const PROFILE_EMOJIS=['ğŸ¯','ğŸ°','ğŸ¼','ğŸ¦Š','ğŸ¨','ğŸµ','ğŸ¦„','ğŸ¦–','ğŸ³','ğŸ™','ğŸ','ğŸ¦‰'];
  const EMO={5:{e:"ğŸ˜Š",n:"ë§¤ìš° ê¸ì •"},4:{e:"ğŸ™‚",n:"ê¸ì •"},3:{e:"ğŸ˜",n:"ë³´í†µ"},2:{e:"ğŸ˜•",n:"ë¶ˆí¸"},1:{e:"ğŸ˜Ÿ",n:"ì–´ë ¤ì›€"},0:{e:"ğŸ˜«",n:"ìœ„ê¸°"}};
  const CTX=["ğŸ˜´ ìˆ˜ë©´ë¶€ì¡±","ğŸ’Š ê±´ê°•ì €í•˜","ğŸ  ê°€ì •ì´ìŠˆ","ğŸ”„ í™œë™ì „í™˜","ğŸ§’ ë˜ë˜ê°ˆë“±","ğŸ‘€ ê´€ì‹¬ìš”êµ¬","ğŸ ê°•í™”ì œìš”êµ¬","ğŸšª ê³¼ì œíšŒí”¼","ğŸŒ€ ê°ê°ì¶”êµ¬","ğŸ”Š ì†ŒìŒë¯¼ê°","ğŸ½ï¸ ë°°ê³ í””","ğŸ¤• í†µì¦/ë¶ˆí¸","ğŸ“… ì¼ì •ë³€ê²½","ğŸšŒ ë“±í•˜êµí”¼ë¡œ","ğŸŒ¤ï¸ ë‚ ì”¨ì˜í–¥"];
  const OPS={
    classes:["A","B","C","D","E","F","G"],
    sex:["ë‚¨","ì—¬"],
    dx:["ì§€ì ì¥ì• ","ìíìŠ¤í™íŠ¸ëŸ¼","ADHD","í•™ìŠµì¥ì• ","ì •ì„œÂ·í–‰ë™ì¥ì• ","ê¸°íƒ€"],
    comm:["êµ¬ì–´","PECS","AAC","ì œìŠ¤ì²˜","ì œí•œì  ì–¸ì–´","ê¸°íƒ€"],
    sensory:["ì²­ê° ê³¼ë¯¼","ì‹œê° ê³¼ë¯¼","ì´‰ê° ê³¼ë¯¼","ì••ë°• ì„ í˜¸","ì›€ì§ì„ ì¶”êµ¬","ê¸°íƒ€"],
    reinf:["ìŠ¤í‹°ì»¤","ìŒì‹","í™œë™","ì „ìê¸°ê¸°","ì‚¬íšŒì  ì¹­ì°¬","ê¸°íƒ€"],
    trigger:["ê³¼ì œ ì „í™˜","ì†ŒìŒ","ì¼ì • ë³€ê²½","ë˜ë˜ ê°ˆë“±","ìš”êµ¬ ê±°ë¶€","ê¸°íƒ€"],
    meds:["ì—†ìŒ","í•­ì •ì‹ ë³‘ì œ","í•­ë¶ˆì•ˆì œ","í•­ê²½ë ¨ì œ","ê¸°íƒ€"]
  };

  // ===== Utils =====
  const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
  const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0];
  const dK=d=>d.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});
  let loaderTimer=null;
  function showLoader(msg){clearTimeout(loaderTimer);$("#loader-msg").textContent=msg||"ì²˜ë¦¬ ì¤‘...";$("#loader").classList.add("show");}
  function hideLoader(){loaderTimer=setTimeout(()=>$("#loader").classList.remove("show"),120);}
  function openModal(id){$(id).classList.add("show");}
  function closeModal(id){$(id).classList.remove("show");}
  function alertBox(msg){$("#doneMsg").textContent=msg||"ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";openModal("#modalDone");}

  // ===== API Layer =====
  async function api(action,params={}){
    if(!SYNC_URL)throw new Error("ì›¹ì•± URL ë¯¸ì„¤ì •");
    const u=new URL(SYNC_URL);
    u.searchParams.set('action',action);
    for(const k in params){const v=params[k];if(v!==undefined && v!==null && v!=="")u.searchParams.set(k,v);}
    const r=await fetch(u,{cache:"no-store"});
    const j=await r.json().catch(()=>({ok:false,error:"JSON íŒŒì‹± ì˜¤ë¥˜"}));
    if(!r.ok || j.error)throw new Error(j?.error||`ì„œë²„ ì˜¤ë¥˜ ${r.status}`);
    return j;
  }
  async function postApi(body){
    if(!SYNC_URL)throw new Error("ì›¹ì•± URL ë¯¸ì„¤ì •");
    const r=await fetch(SYNC_URL,{method:"POST",body:JSON.stringify(body)});
    const j=await r.json().catch(()=>({ok:false,error:"JSON íŒŒì‹± ì˜¤ë¥˜"}));
    if(!r.ok || j.error)throw new Error(j?.error||`ì„œë²„ ì˜¤ë¥˜ ${r.status}`);
    return j;
  }
  function setSyncUrl(url){
    SYNC_URL=url.trim();
    localStorage.setItem(KEY_URL,SYNC_URL);
    $("#linkStatus").textContent=SYNC_URL?"ì„¤ì •ë¨":"ë¯¸ì„¤ì •";
    if(SYNC_URL) initLoginScreen();
  }

  // ===== UI Builders =====
  function chips(el, list, single=false){
    const c=$(el); if(!c)return;
    c.innerHTML = list.map(v=>`<div class="chip" data-v="${v}">${v}</div>`).join("");
    c.onclick = e => { const t=e.target.closest(".chip"); if(!t)return;
      if(single){ c.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected")); t.classList.add("selected"); }
      else t.classList.toggle("selected");
    };
    return c;
  }
  const getChips = el => $$(el+" .chip.selected").map(x=>x.dataset.v);
  function setChips(el, selected=[], list=[], single=false){
    const c=$(el); if(!c)return;
    c.innerHTML = list.map(v=>`<div class="chip ${selected.includes(v)?'selected':''}" data-v="${v}">${v}</div>`).join("");
    c.onclick = e => { const t=e.target.closest(".chip"); if(!t)return;
      if(single){ c.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected")); t.classList.add("selected"); }
      else t.classList.toggle("selected");
    };
  }
  function emojiPicker(containerId, avatarId){
    const p=$("#"+containerId), a=$("#"+avatarId); if(!p||!a)return;
    p.innerHTML = PROFILE_EMOJIS.map(em=>`<div class="emoji-choice" data-emoji="${em}">${em}</div>`).join("");
    p.onclick = e => { const t=e.target.closest(".emoji-choice"); if(!t)return;
      p.querySelectorAll(".emoji-choice").forEach(x=>x.classList.remove("selected"));
      t.classList.add("selected"); a.textContent=t.dataset.emoji; a.style.backgroundImage=''; a.dataset.selected=t.dataset.emoji;
    };
  }

  // ===== Renderers =====
  function renderStudents(scrollerSel){
    const sc=$(scrollerSel);
    const list = session.role==="admin" ? students : [session.user];
    sc.innerHTML = list.map(s=>{
      const hasImg = (s.photo||'').startsWith('data:image');
      return `<div class="stu" data-id="${s.id}" title="${s.name}">
        <div class="avatar" style="${hasImg?`background-image:url(${s.photo})`:''}">${hasImg?'':(s.photo||'ğŸ‘¤')}</div>
        <div style="font-weight:800;margin-top:6px">${s.name}</div>
      </div>`;
    }).join("") || `<div class="muted">í•™ìƒ ì—†ìŒ</div>`;
    sc.onclick = e => {
      const card=e.target.closest(".stu"); if(!card)return;
      sc.querySelectorAll(".stu").forEach(x=>x.classList.remove("selected"));
      card.classList.add("selected");
      const s = students.find(x=>String(x.id)===String(card.dataset.id));
      const p=scrollerSel.includes("am")?"am":"pm";
      $("#"+p+"Form").classList.remove("hide");
      $("#"+p+"Who").textContent = `${s?.name||''} Â· ê°ì • ì…ë ¥`;
      sc.dataset.sel = card.dataset.id;
    };
  }
  function renderEmo(prefix, brief=false){
    const box=$("#"+prefix+"Emotions");
    box.innerHTML = Object.keys(EMO).sort((a,b)=>b-a).map(k=>{
      const v=EMO[k];
      return `<div class="emoBtn" data-score="${k}" title="${v.n}">
        <div style="font-size:28px">${v.e}</div>
        <div><div style="font-weight:800">${k}ì  Â· ${v.n}</div>${brief?'':`<div class="muted" style="font-size:12px">ì„ íƒí•˜ë©´ ë§¥ë½ì„ ê³ ë¥¼ ìˆ˜ ìˆì–´ìš”</div>`}</div>
      </div>`;
    }).join("");
    box.onclick=e=>{
      const b=e.target.closest(".emoBtn"); if(!b)return;
      box.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active"); box.dataset.score=b.dataset.score;
      $("#"+prefix+"CtxWrap").classList.remove("hide");
    };
  }
  function renderCtx(prefix){
    const el=$("#"+prefix+"Ctx");
    el.innerHTML = CTX.map(t=>`<div class="chip" data-k="${t}">${t}</div>`).join("");
    el.onclick=e=>{const c=e.target.closest(".chip"); if(!c)return; c.classList.toggle("selected");};
  }

  // ===== Status / Completion =====
  async function updateStudentCardStatus(prefix, date){
    if(session.role!=='admin') return false;
    try{
      const dateStr=fmt(date);
      const day=(await api('get_emotions',{from:dateStr,to:dateStr})).emotion[dateStr]||{};
      const scroller=$("#"+prefix+"Scroller");
      const cards = scroller.querySelectorAll(".stu");
      let all=true;
      cards.forEach(card=>{
        const sid=card.dataset.id;
        const slot=prefix==='am'?'morning':'afternoon';
        if(day[sid]?.[slot]) card.classList.add("completed");
        else{ card.classList.remove("completed"); all=false; }
      });
      return all;
    }catch(e){console.warn("ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨:",e.message);return false;}
  }

  // ===== Data Fetch =====
  async function fetchStudents(){
    if(!SYNC_URL){
      students=[
        {id:"1",name:"ìƒ˜í”ŒA",photo:"ğŸ‘¤",classes:["A"],sex:"ë‚¨",dx:["ì§€ì ì¥ì• "],comm:["êµ¬ì–´"]},
        {id:"2",name:"ìƒ˜í”ŒB",photo:"ğŸ‘¤",classes:["A"],sex:"ì—¬",dx:["ìíìŠ¤í™íŠ¸ëŸ¼"],comm:["PECS"]},
        {id:"3",name:"ìƒ˜í”ŒC",photo:"ğŸ‘¤",classes:["B"],sex:"ë‚¨",dx:["ì§€ì ì¥ì• ","ADHD"],comm:["ì œìŠ¤ì²˜"]},
      ];
      renderStudents("#amScroller"); renderStudents("#pmScroller"); return;
    }
    students = (await api('get_students')).students||[];
    if(session.role==='admin'){ renderStudents("#amScroller"); renderStudents("#pmScroller"); }
  }
  async function fetchEmotionsAll(){
    if(!SYNC_URL){ emotionData={}; return; }
    emotionData = (await api('get_emotions')).emotion||{};
  }

  // ===== Data Manager / Graph =====
  function renderDataFilters(){
    const s=$('#dataStudentSelect');
    s.innerHTML = `<option value="">í•™ìƒ ì „ì²´</option>` + (students||[]).map(st=>`<option value="${st.name}">${st.name}</option>`).join('');
  }
  function renderDataTable(name="",slot=""){
    const b=$("#dataBody"); b.innerHTML="";
    const dates=Object.keys(emotionData).sort((a,b)=>b.localeCompare(a));
    dates.forEach(k=>{
      const day=emotionData[k];
      Object.keys(day).forEach(sid=>{
        const rec=day[sid]; const nm=rec.name||""; if(name && nm!==name) return;
        ['morning','afternoon'].forEach(sl=>{
          if(slot && sl!==slot) return;
          const cur=rec[sl]; if(!cur) return;
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${k}</td><td>${nm}</td><td>${sl==="morning"?"ë“±êµ":"í•˜êµ"}</td><td>${cur.score}</td><td>${(cur.context||[]).join(", ")}</td><td><div class="row" style="justify-content:center"><button class="btn" data-edit="true">ìˆ˜ì •</button><button class="btn danger" data-del="true">ì‚­ì œ</button></div></td>`;
          tr.dataset.date=k; tr.dataset.sid=sid; tr.dataset.slot=sl; tr.dataset.score=cur.score; tr.dataset.context=(cur.context||[]).join(',');
          b.appendChild(tr);
        });
      });
    });
  }
  function getRangeSeries(sid,from,to,emo){
    const labels=[],am=[],pm=[];
    const cur=new Date(from), end=new Date(to);
    while(cur<=end){
      const k=fmt(cur); const r=emo?.[k]?.[sid];
      labels.push(k.slice(5)); am.push(r?.morning?.score??null); pm.push(r?.afternoon?.score??null);
      cur.setDate(cur.getDate()+1);
    }
    return {labels,am,pm};
  }
  function drawChart(labels,am,pm){
    const ctx=$("#chart").getContext('2d');
    if(chartInstance) chartInstance.destroy();
    Chart.register(ChartDataLabels);
    chartInstance=new Chart(ctx,{
      type:'line',
      data:{labels,datasets:[
        {label:'ë“±êµ',data:am,borderColor:'#ef4444',backgroundColor:'#ef4444',radius:5,tension:0.1},
        {label:'í•˜êµ',data:pm,borderColor:'#2563eb',backgroundColor:'#2563eb',radius:5,tension:0.1}
      ]},
      options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:5,ticks:{stepSize:1}}},plugins:{datalabels:{align:'top',color:'#111827',font:{weight:'bold'},formatter:v=>v}}}
    });
  }
  function generateReport(stu,from,to,emo){
    const box=$("#reportBox");
    const recs=[];
    const cur=new Date(from),end=new Date(to);
    while(cur<=end){
      const k=fmt(cur); const r=emo[k]?.[stu.id];
      if(r?.morning) recs.push({score:r.morning.score,ctx:r.morning.context||[]});
      if(r?.afternoon) recs.push({score:r.afternoon.score,ctx:r.afternoon.context||[]});
      cur.setDate(cur.getDate()+1);
    }
    if(recs.length===0){ box.innerHTML='<div class="muted">ì„ íƒ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    const low=recs.filter(r=>r.score<=1);
    const ctxCount={}; low.forEach(r=>r.ctx.forEach(c=>ctxCount[c]=(ctxCount[c]||0)+1));
    const topCtx=Object.entries(ctxCount).sort((a,b)=>b[1]-a[1]).slice(0,3);
    const key=topCtx[0]?.[0]||"íŠ¹ì • ë§¥ë½";

    box.innerHTML = `
      <h3 style="margin:4px 0 8px">ì „ë¬¸ê°€ ì†Œê²¬</h3>
      <ul>
        <li><b>í–‰ë™ë¶„ì„:</b> ${key} ìƒí™©ì—ì„œ ë‚®ì€ ì •ì„œ ì ìˆ˜ê°€ ë¹ˆë²ˆí•©ë‹ˆë‹¤. ê¸°ëŠ¥ ê°€ì„¤(ì£¼ì˜íšë“/íšŒí”¼/ìœ í˜•ì²´ê°ê°/ìë™ê°•í™”)ì„ ABCë¡œ ì ê²€í•˜ì„¸ìš”.</li>
        <li><b>ê°ê°:</b> ì†ŒìŒÂ·ê°ê° ë‹¨ì„œê°€ ìˆìœ¼ë©´ í™˜ê²½ ì¡°ì ˆ(ì†Œë¦¬ ì°¨ë‹¨, ì˜ˆê³ , ëŒ€ì²´ê°ê°) ìš°ì„ .</li>
        <li><b>ì¸ì§€-í–‰ë™:</b> ê°ì • ì¸ì‹/í‘œí˜„ ìŠ¤ì¼€ì¼ í›ˆë ¨ê³¼ ê¸°ëŠ¥ì  ì˜ì‚¬ì†Œí†µ(FCT) ë³‘í–‰.</li>
      </ul>
      <h3 style="margin:12px 0 6px">ì¤‘ì¬ ê³„íš</h3>
      <ul>
        <li><b>ë°°ê²½ì‚¬ê±´:</b> ìˆ˜ë©´Â·ì‹ì‚¬ ë£¨í‹´, ì¼ì • ì˜ˆê³ </li>
        <li><b>ì„ í–‰ì‚¬ê±´:</b> ì „í™˜ ì˜ˆê³ , ê³¼ì œ ë‚œì´ë„ ì¡°ì ˆ, ì„ íƒê¶Œ</li>
        <li><b>ëŒ€ì²´ê¸°ìˆ :</b> ë„ì›€ì´ í•„ìš”í•´ìš”/ì‰¬ì–´ìš” ë“±ì˜ FCT</li>
        <li><b>ê°•í™”:</b> ê¸ì • ì°¸ì—¬ ì¦‰ì‹œ ê°•í™”(í† í°/ì‹œê°í‘œ)</li>
        <li><b>ìœ„ê¸°:</b> ì•ˆì „Â·ì•ˆì •í™” â†’ ë³µê·€ ì ˆì°¨</li>
      </ul>`;
  }

  // ===== Save Emotion =====
  async function saveEmotion(prefix, btn){
    btn.disabled=true; showLoader("ì €ì¥ ì¤‘...");
    try{
      let sid = (session.role==='student') ? session.user.id : $("#"+prefix+"Scroller").dataset.sel;
      const box=$("#"+prefix+"Emotions");
      const score=box.dataset.score;
      if(!sid||score===undefined) throw new Error("í•™ìƒê³¼ ì ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      const date = prefix==='am'? amDate : pmDate;
      const ctxSel = $$("#"+prefix+"Ctx .chip.selected").map(x=>x.dataset.k);
      if(SYNC_URL){
        await postApi({action:"add_emotion",date:fmt(date),student_id:sid,slot:(prefix==="am"?"morning":"afternoon"),score:Number(score),context:ctxSel});
      } else {
        alertBox("ì—°ê²°ì´ ì„¤ì •ë˜ì§€ ì•Šì•„ ì‹¤ì œ ì €ì¥ì€ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. âš™ï¸ì—ì„œ URLì„ ì„¤ì •í•˜ì„¸ìš”.");
      }
      alertBox("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      // reset
      box.querySelector(".active")?.classList.remove("active"); box.dataset.score="";
      $("#"+prefix+"CtxWrap").classList.add("hide"); $$("#"+prefix+"Ctx .chip").forEach(x=>x.classList.remove("selected"));
      if(session.role==='admin'){
        const scroller=$("#"+prefix+"Scroller"); scroller.querySelector(".selected")?.classList.remove("selected"); $("#"+prefix+"Form").classList.add("hide");
        const all = await updateStudentCardStatus(prefix, date);
        if(all){
          alertBox("ëª¨ë“  í•™ìƒ ì…ë ¥ ì™„ë£Œ. ë‹¤ìŒ ë‚ ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
          date.setDate(date.getDate()+1); await setDates();
        }
      }
    }catch(e){ alertBox("ì €ì¥ ì‹¤íŒ¨: "+e.message); }
    finally{ btn.disabled=false; hideLoader(); }
  }

  // ===== Tabs & Dates =====
  async function setDates(){
    $("#amDate").textContent=dK(amDate); $("#pmDate").textContent=dK(pmDate);
    $("#amDatePicker").value=fmt(amDate); $("#pmDatePicker").value=fmt(pmDate);
    if(session.role==='admin'){ showLoader("ì…ë ¥ í˜„í™© í™•ì¸ ì¤‘..."); try{ await Promise.all([updateStudentCardStatus('am',amDate),updateStudentCardStatus('pm',pmDate)]);} catch(_){} finally{ hideLoader(); } }
  }
  async function switchTab(id){
    // ëª¨ë“  íƒ­ íŒ¨ë„ ê°ì¶¤ í›„ í•´ë‹¹ íƒ­ë§Œ í‘œì‹œ
    $$(".tab").forEach(t=>{
      const active=(t.dataset.tab===id);
      t.classList.toggle("active", active);
      t.setAttribute("aria-selected", active?'true':'false');
    });
    $$("[id^='tab-']").forEach(p=>p.classList.add("hide"));
    document.getElementById("tab-"+id)?.classList.remove("hide");

    showLoader("ë¡œë”©...");
    try{
      if(session.role==='admin'){
        await fetchStudents();
        if(id==="list") renderStudentList();
        else if(id==="data"){ await fetchEmotionsAll(); renderDataFilters(); renderDataTable(); }
        else if(id==="graph"){ renderGraphStudentSelect(); }
        else if(id==="users"){ await renderUserManagement(); }
      }
    }catch(e){ console.warn("íƒ­ ë¡œë”© ì—ëŸ¬:", e.message); }
    finally{ hideLoader(); }
  }

  // ===== Lists =====
  function renderStudentList(){
    const l=students;
    $("#stuList").innerHTML = l.map(s=>`
      <div class="row" style="justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:8px 0">
        <div class="row">
          <div class="avatar" style="${(s.photo||'').startsWith('data:image')?`background-image:url(${s.photo})`:''}">${(s.photo||'').startsWith('data:image')?'':s.photo||'ğŸ‘¤'}</div>
          <div>
            <div><b>${s.name}</b> <span class="muted">(${(s.classes||[]).join(", ")})</span></div>
            <div class="muted" style="font-size:12px">${(s.dx||[]).join('/')} Â· ${(s.comm||[]).join('/')}</div>
          </div>
        </div>
        <div class="row">
          <button class="btn" data-edit="${s.id}">ìˆ˜ì •</button>
          <button class="btn danger" data-del="${s.id}">ì‚­ì œ</button>
        </div>
      </div>
    `).join("") || `<div class="muted">í•™ìƒ ì—†ìŒ</div>`;
  }
  function renderGraphStudentSelect(){
    const s=$("#graphStudent");
    s.innerHTML = `<option value="">í•™ìƒ ì„ íƒ</option>` + students.map(st=>`<option value="${st.id}">${st.name}</option>`).join("");
  }

  // ===== User Management =====
  async function renderUserManagement(){
    if(!SYNC_URL){ $('#userBody').innerHTML='<tr><td colspan="4">âš ï¸ ì—°ë™ í›„ ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</td></tr>'; return; }
    const {users}=await api('get_users');
    $('#userBody').innerHTML = users.map(u=>`
      <tr>
        <td>${u.username}</td><td>${u.role}</td>
        <td><input type="password" class="pw-input" data-username="${u.username}" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"></td>
        <td><button class="btn primary save-pw-btn" data-username="${u.username}">ì €ì¥</button></td>
      </tr>`).join('');
  }

  // ===== Media Utils =====
  async function fileToDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=e=>res(e.target.result); r.readAsDataURL(file); }); }

  // ===== Login Screen =====
  async function initLoginScreen(){
    const sel=$("#userSelect");
    sel.innerHTML = '<option value="admin" selected>admin</option>';
    if(!SYNC_URL) return;
    showLoader("ì‚¬ìš©ì ëª©ë¡ ë¡œë”©...");
    try{
      const {users}=await api('get_users');
      const opts = users.map(u=>u.username).filter(u=>u && u!=='admin').map(u=>`<option value="${u}">${u}</option>`).join('');
      sel.insertAdjacentHTML('beforeend', opts);
    }catch(e){ console.warn("ì‚¬ìš©ì ëª©ë¡ ì‹¤íŒ¨:", e.message); }
    finally{ hideLoader(); }
  }

  // ===== Setup UI for Roles =====
  function setupAdmin(){
    document.body.className='role-admin';
    $("#who").textContent='ê´€ë¦¬ì';
    renderEmo("am"); renderEmo("pm");
    renderCtx("am"); renderCtx("pm");
    chips("#chipsClass",OPS.classes); chips("#chipsSex",OPS.sex,true);
    chips("#chipsDx",OPS.dx); chips("#chipsComm",OPS.comm);
    chips("#chipsSensory",OPS.sensory); chips("#chipsReinf",OPS.reinf);
    chips("#chipsTrigger",OPS.trigger); chips("#chipsMeds",OPS.meds);
    emojiPicker('newEmojiPicker','newAvatar'); emojiPicker('editEmojiPicker','editAvatar');
    fetchStudents(); setDates();

    // ì´ˆê¸° íƒ­ íŒ¨ë„ ë³´ì •: AMë§Œ í‘œì‹œ
    $$("[id^='tab-']").forEach(p=>p.classList.add("hide"));
    $("#tab-am").classList.remove("hide");
    $$(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelector('.tab[data-tab="am"]').classList.add("active");
  }
  function setupStudent(){
    document.body.className='role-student';
    $("#who").textContent=session.user.name;
    $("#amForm").classList.remove("hide"); $("#pmForm").classList.add("hide");
    renderEmo("am",true); renderEmo("pm",true);
    renderCtx("am"); renderCtx("pm");
    setDates();

    // ì´ˆê¸° íƒ­ ë³´ì •
    $$("[id^='tab-']").forEach(p=>p.classList.add("hide"));
    $("#tab-am").classList.remove("hide");
    $$(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelector('.tab[data-tab="am"]').classList.add("active");
  }

  // ===== Event Bindings =====
  $("#gear").onclick=()=>openModal("#modalSettings");
  $("#doneOk").onclick=()=>closeModal("#modalDone");
  $("#saveUrl").onclick=()=>{ setSyncUrl($("#syncUrlInput").value); alertBox("URL ì €ì¥ë¨"); closeModal("#modalSettings"); };
  $$(".tab").forEach(t=>t.onclick=()=>switchTab(t.dataset.tab));

  // ë¡œê·¸ì¸: admin ì¦‰ì‹œ(ë¹„ë²ˆ ë¬´ì‹œ), ê·¸ ì™¸ ì„œë²„ ê²½ìœ 
  $("#btnLogin").onclick=async()=>{
    const username=$("#userSelect").value||"admin";
    const password=$("#password").value;
    const btn=$("#btnLogin"); btn.disabled=true; showLoader("ë¡œê·¸ì¸...");
    try{
      if(username==="admin"){
        session = { ok:true, role:'admin', user:{id:'admin',name:'ê´€ë¦¬ì'} };
        $("#login").classList.add("hide"); $("#app").classList.remove("hide"); setupAdmin(); hideLoader(); btn.disabled=false; return;
      }
      const r=await postApi({action:'login',username,password});
      if(!r.ok) throw new Error(r.error);
      session=r;
      $("#login").classList.add("hide"); $("#app").classList.remove("hide");
      if(session.role==='admin') setupAdmin(); else setupStudent();
    }catch(e){ alertBox("ë¡œê·¸ì¸ ì‹¤íŒ¨: "+e.message); }
    finally{ btn.disabled=false; hideLoader(); }
  };
  $("#password").onkeydown=e=>{ if(e.key==="Enter") $("#btnLogin").click(); };
  $("#btnLogout").onclick=()=>location.reload();

  // ë‚ ì§œ/íƒìƒ‰
  $("#amPrev").onclick=async()=>{ amDate.setDate(amDate.getDate()-1); await setDates(); };
  $("#amNext").onclick=async()=>{ amDate.setDate(amDate.getDate()+1); await setDates(); };
  $("#pmPrev").onclick=async()=>{ pmDate.setDate(pmDate.getDate()-1); await setDates(); };
  $("#pmNext").onclick=async()=>{ pmDate.setDate(pmDate.getDate()+1); await setDates(); };
  $("#amDateBtn").onclick=()=>$("#amDatePicker").showPicker?.();
  $("#pmDateBtn").onclick=()=>$("#pmDatePicker").showPicker?.();
  $("#amDatePicker").onchange=async e=>{ amDate=new Date(e.target.value); await setDates(); };
  $("#pmDatePicker").onchange=async e=>{ pmDate=new Date(e.target.value); await setDates(); };

  // ì €ì¥
  $("#amSave").onclick=e=>saveEmotion('am',e.target);
  $("#pmSave").onclick=e=>saveEmotion('pm',e.target);

  // í•™ìƒ ë“±ë¡
  $("#addStu").onclick=async e=>{
    const btn=e.target; btn.disabled=true; showLoader("ë“±ë¡...");
    try{
      const name=$("#newName").value.trim(); if(!name) throw new Error("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");
      const username=$("#newUsername").value.trim(); if(!username) throw new Error("ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      const password=$("#newPassword").value.trim(); if(!password) throw new Error("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
      let photo=$("#newAvatar").dataset.selected||'ğŸ‘¤';
      const f=$("#photo").files[0]; if(f) photo=await fileToDataURL(f);
      const s={id:0,name:name,photo:photo,classes:getChips("#chipsClass"),sex:getChips("#chipsSex")[0]||"",dx:getChips("#chipsDx"),comm:getChips("#chipsComm"),sensory:getChips("#chipsSensory"),reinf:getChips("#chipsReinf"),trigger:getChips("#chipsTrigger"),meds:getChips("#chipsMeds"),parent:$("#newParent").value.trim(),username,password};
      if(SYNC_URL){ await postApi({action:"add_student",student:s}); alertBox("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤."); await fetchStudents(); await initLoginScreen(); }
      else { alertBox("ì—°ê²° ì €ì¥ í›„ ë“±ë¡ì´ ë°˜ì˜ë©ë‹ˆë‹¤."); }
      // reset
      $$("#tab-new .chip.selected").forEach(c=>c.classList.remove("selected"));
      ["newName","newUsername","newPassword","newParent"].forEach(id=>$("#"+id).value="");
      $("#photo").value="";
      const av=$("#newAvatar"); av.textContent="ğŸ‘¤"; av.style.backgroundImage=''; av.dataset.selected="";
    }catch(err){ alertBox("ë“±ë¡ ì‹¤íŒ¨: "+err.message); }
    finally{ btn.disabled=false; hideLoader(); }
  };
  $("#photo").onchange=async e=>{ const f=e.target.files[0]; if(!f) return; const dataUrl=await fileToDataURL(f); const av=$("#newAvatar"); av.style.backgroundImage=`url(${dataUrl})`; av.textContent=''; av.dataset.selected=dataUrl; $$("#newEmojiPicker .emoji-choice").forEach(c=>c.classList.remove('selected')); };

  // í•™ìƒ ë¦¬ìŠ¤íŠ¸ ìˆ˜ì •/ì‚­ì œ
  $("#stuList").onclick=async e=>{
    const edit=e.target.closest("[data-edit]"), del=e.target.closest("[data-del]");
    if(edit){
      editTargetId=edit.dataset.edit;
      const s=students.find(x=>String(x.id)===String(editTargetId)); if(!s) return;
      $("#editName").value=s.name||"";
      const av=$("#editAvatar"); if((s.photo||'').startsWith('data:image')){ av.style.backgroundImage=`url(${s.photo})`; av.textContent=''; } else { av.style.backgroundImage=''; av.textContent=s.photo||'ğŸ‘¤'; }
      av.dataset.selected=s.photo; $("#editPhoto").value="";
      setChips("#editClass",s.classes,OPS.classes); setChips("#editSex",[s.sex],OPS.sex,true); setChips("#editDx",s.dx,OPS.dx);
      setChips("#editComm",s.comm,OPS.comm); setChips("#editSensory",s.sensory,OPS.sensory); setChips("#editReinf",s.reinf,OPS.reinf);
      setChips("#editTrigger",s.trigger,OPS.trigger); setChips("#editMeds",s.meds,OPS.meds);
      $("#editParent").value=s.parent||""; openModal("#modalEdit");
    }
    if(del){
      if(!confirm("í•™ìƒê³¼ í•´ë‹¹ í•™ìƒì˜ ë¡œê·¸ì¸ ê³„ì •ì´ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í• ê¹Œìš”?")) return;
      showLoader("ì‚­ì œ...");
      try{
        if(!SYNC_URL) throw new Error("ì—°ê²° ë¯¸ì„¤ì •");
        await postApi({action:"delete_student",id:del.dataset.del});
        alertBox("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); await fetchStudents(); await initLoginScreen(); await switchTab("list");
      }catch(err){ alertBox("ì‚­ì œ ì‹¤íŒ¨: "+err.message); }
      finally{ hideLoader(); }
    }
  };
  $("#editSave").onclick=async e=>{
    const btn=e.target; btn.disabled=true; showLoader("ìˆ˜ì •...");
    try{
      const s=students.find(x=>String(x.id)===String(editTargetId)); if(!s) throw new Error("í•™ìƒ ì •ë³´ ì—†ìŒ");
      s.name=$("#editName").value.trim();
      s.photo=$("#editAvatar").dataset.selected||s.photo;
      const pf=$("#editPhoto").files[0]; if(pf) s.photo=await fileToDataURL(pf);
      s.classes=getChips("#editClass"); s.sex=getChips("#editSex")[0]||""; s.dx=getChips("#editDx"); s.comm=getChips("#editComm");
      s.sensory=getChips("#editSensory"); s.reinf=getChips("#editReinf"); s.trigger=getChips("#editTrigger"); s.meds=getChips("#editMeds");
      s.parent=$("#editParent").value.trim();
      if(SYNC_URL){ await postApi({action:"update_student",student:s}); alertBox("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); await fetchStudents(); await switchTab("list"); }
      else { alertBox("ì—°ê²° í›„ ìˆ˜ì •ì´ ë°˜ì˜ë©ë‹ˆë‹¤."); }
      closeModal("#modalEdit");
    }catch(err){ alertBox("ìˆ˜ì • ì‹¤íŒ¨: "+err.message); }
    finally{ btn.disabled=false; hideLoader(); }
  };
  $("#editPhoto").onchange=async e=>{ const f=e.target.files[0]; if(!f)return; const dataUrl=await fileToDataURL(f); const av=$("#editAvatar"); av.style.backgroundImage=`url(${dataUrl})`; av.textContent=''; av.dataset.selected=dataUrl; $$("#editEmojiPicker .emoji-choice").forEach(c=>c.classList.remove('selected')); };

  // ê¸°ë¡ ìˆ˜ì •/ì‚­ì œ
  $("#dataBody").onclick=async e=>{
    const del=e.target.closest("[data-del]"), edit=e.target.closest("[data-edit]");
    if(del){
      if(!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      const tr=del.closest("tr"); showLoader("ì‚­ì œ...");
      try{
        if(!SYNC_URL) throw new Error("ì—°ê²° ë¯¸ì„¤ì •");
        await postApi({action:"delete_emotion",date:tr.dataset.date,student_id:tr.dataset.sid,slot:tr.dataset.slot});
        alertBox("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); tr.remove();
      }catch(err){ alertBox("ì‚­ì œ ì‹¤íŒ¨: "+err.message); }
      finally{ hideLoader(); }
    }
    if(edit){
      const tr=edit.closest("tr");
      editEmotionTarget={date:tr.dataset.date,sid:tr.dataset.sid,slot:tr.dataset.slot};
      $("#editEmotionInfo").textContent = `${tr.children[0].textContent} / ${tr.children[1].textContent} / ${tr.children[2].textContent}`;
      $("#editEmotionScore").value = tr.dataset.score;
      $("#editEmotionContext").value = tr.dataset.context;
      openModal("#modalEditEmotion");
    }
  };
  $("#editEmotionSave").onclick=async e=>{
    const btn=e.target; btn.disabled=true; showLoader("ìˆ˜ì •...");
    try{
      const score=Number($("#editEmotionScore").value);
      const ctx=$("#editEmotionContext").value.split(',').map(s=>s.trim()).filter(Boolean);
      if(score<0||score>5) throw new Error("ì ìˆ˜ëŠ” 0~5 ë²”ìœ„");
      if(SYNC_URL){ await postApi({action:'update_emotion',date:editEmotionTarget.date,student_id:editEmotionTarget.sid,slot:editEmotionTarget.slot,score,context:ctx}); alertBox("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); await fetchEmotionsAll(); renderDataTable(); }
      else { alertBox("ì—°ê²° í›„ ìˆ˜ì •ì´ ë°˜ì˜ë©ë‹ˆë‹¤."); }
      closeModal("#modalEditEmotion");
    }catch(err){ alertBox("ìˆ˜ì • ì‹¤íŒ¨: "+err.message); }
    finally{ btn.disabled=false; hideLoader(); }
  };

  // ë°ì´í„° ê´€ë¦¬ í•„í„°
  $("#dataStudentSelect").onchange=e=>renderDataTable(e.target.value, $("#dataSlotSelect").value);
  $("#dataSlotSelect").onchange=e=>renderDataTable($("#dataStudentSelect").value, e.target.value);
  $("#btnClear").onclick=()=>{ $("#dataStudentSelect").value=""; $("#dataSlotSelect").value=""; renderDataTable(); };

  // ê·¸ë˜í”„/ë³´ê³ ì„œ
  function defaultDates(){ const past=new Date(); past.setDate(past.getDate()-14); $("#fromDate").value=fmt(past); $("#toDate").value=fmt(new Date()); }
  defaultDates();
  $("#btnGraph").onclick=async()=>{
    const from=$("#fromDate").value, to=$("#toDate").value; if(!from||!to) return alertBox("ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.");
    let sid, name;
    if(session.role==='student'){ sid=session.user.id; name=session.user.name; }
    else { sid=$("#graphStudent").value; if(!sid) return alertBox("í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”."); name=students.find(s=>String(s.id)===String(sid))?.name; }
    showLoader("ê·¸ë˜í”„ ìƒì„±...");
    try{
      let emo={emotion:{}}; if(SYNC_URL) emo=await api('get_emotions',{from,to,studentId:sid});
      const g=getRangeSeries(sid,from,to,emo.emotion);
      $("#graphTitle").textContent = `${name} Â· ê°ì • ì¶”ì´ (${from} ~ ${to})`;
      drawChart(g.labels,g.am,g.pm);
      if(session.role==='admin'){ generateReport(students.find(s=>String(s.id)===String(sid))||{id:sid,name},from,to,emo.emotion); }
    }catch(e){ alertBox("ê·¸ë˜í”„ ì‹¤íŒ¨: "+e.message); $("#graphTitle").textContent=''; if(chartInstance){chartInstance.destroy(); chartInstance=null;} }
    finally{ hideLoader(); }
  };
  $("#btnPrint").onclick=()=>window.print();

  // ê¸°íƒ€
  $("#manualSync").onclick=async()=>{ showLoader("ë™ê¸°í™”..."); try{ await fetchStudents(); if(session.role!=='student') await setDates(); alertBox("ë™ê¸°í™” ì™„ë£Œ"); } catch(e){ alertBox("ë™ê¸°í™” ì‹¤íŒ¨: "+e.message); } finally{ hideLoader(); } };
  $("#openSheet").onclick=async()=>{ try{ if(!SYNC_URL) throw new Error("ì—°ê²° ë¯¸ì„¤ì •"); const {sheetUrl}=await api('get_sheet_url'); if(sheetUrl) window.open(sheetUrl,'_blank'); } catch(e){ alertBox("ì‹œíŠ¸ ì—´ê¸° ì‹¤íŒ¨: "+e.message); } };

  // ==== ì´ˆê¸°í™”: íƒ­ UIê°€ ê²¹ì³ ë³´ì´ëŠ” ë¬¸ì œ ë°©ì§€ ====
  // ëª¨ë“  íƒ­ì„ ìš°ì„  ê°ì¶”ê³  AMë§Œ í‘œì‹œ
  $$("[id^='tab-']").forEach(p=>p.classList.add("hide"));
  $("#tab-am").classList.remove("hide");

  setSyncUrl(SYNC_URL);
  initLoginScreen();
});
</script>
</body>
</html>
