<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>감정 데이터 입력 (학급)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
  :root{--bg:#f7f9fc;--panel:#ffffff;--text:#0f172a;--muted:#64748b;--primary:#4f46e5;--accent:#22c55e;--danger:#ef4444;--border:#e5e7eb;--chip:#f1f5f9;--completed-bg:#dcfce7;--completed-border:#22c55e;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",sans-serif;font-size:15px}
  .wrap{max-width:1180px;margin:0 auto;padding:14px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 16px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;min-height:40px;font-size:15px}
  .btn.primary{background:var(--primary);color:#fff;border-color:transparent} .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
  .btn.ghost{background:#fff;color:#0f172a}
  .btn:disabled{background:#e5e7eb;cursor:not-allowed;color:#9ca3af}
  .tabs{display:flex;gap:10px;overflow-x:auto;margin-bottom:12px;-ms-overflow-style:none;scrollbar-width:none} .tabs::-webkit-scrollbar{display:none}
  .tab{padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700;white-space:nowrap}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  .admin-only, .student-only {display:none!important}
  body.role-admin .admin-only {display:flex!important}
  body.role-student .student-only {display:flex!important}
  .tab.admin-only, .tab.student-only {display:none!important}
  body.role-admin .tab.admin-only {display:inline-flex!important}
  body.role-student .tab.student-only {display:inline-flex!important}
  input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;min-height:42px;background:#fff}
  .scroller{display:flex;gap:12px;overflow-x:auto;padding:6px 2px;-webkit-overflow-scrolling:touch;-ms-overflow-style:none;scrollbar-width:none} .scroller::-webkit-scrollbar{display:none}
  .stu{flex:0 0 160px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:12px;text-align:center;cursor:pointer;transition:background-color 0.3s, border-color 0.3s;}
  .stu.selected{border-color:var(--primary);box-shadow:0 0 0 3px rgba(79,70,229,.3)}
  .stu.completed{background-color:var(--completed-bg);border-color:var(--completed-border);}
  .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#e5e7eb;border:2px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.06);font-size:48px;line-height:64px;text-align:center;background-size:cover;background-position:center}
  .emoBtn{display:flex;align-items:center;gap:12px;border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff;cursor:pointer}
  .emoBtn.active{border-color:var(--primary);background:rgba(79,70,229,.05)}
  .context{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .chip{padding:9px 12px;border-radius:999px;border:1px solid var(--border);background:var(--chip);font-size:13px;cursor:pointer;text-align:center;user-select:none}
  .chip.selected{background:var(--primary);color:#fff;border-color:transparent}
  table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border:1px solid #ddd;padding:8px;text-align:center;font-size:14px}th{background:#f3f4f6}
  .hide{display:none!important}
  .chart-container{position:relative;height:420px;width:100%;margin-top:10px}
  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .brand{display:flex;align-items:center;gap:10px}
  .title{font-weight:900;font-size:20px} .muted{color:#64748b}
  .iconbtn-group{display:flex;align-items:center;gap:4px}
  .iconbtn{display:flex;flex-direction:column;align-items:center;justify-content:center;width:56px;height:56px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:20px;gap:2px}
  .iconbtn .label{font-size:10px;font-weight:bold}
  @media(max-width:640px){.stu{flex:0 0 140px}.title{font-size:18px}.topbar{flex-direction:column;align-items:stretch;gap:16px}}
  @media print{.no-print{display:none!important}body{background:#fff}.card{border:0;box-shadow:none}#reportBox{padding:0}@page{size:A4;margin:12mm}}
  .modal{position:fixed;inset:0;background:rgba(15,23,42,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
  .modal.show{display:flex}
  .modal .box{background:#fff;border-radius:16px;max-width:480px;width:100%;padding:18px;border:1px solid var(--border);box-shadow:0 24px 48px rgba(0,0,0,.25);max-height:90vh;overflow-y:auto;}
  .modal .box h3{margin:0 0 8px 0}
  .loader{position:fixed;inset:0;background:rgba(255,255,255,.7);display:none;align-items:center;justify-content:center;z-index:100;flex-direction:column;gap:10px;font-weight:bold;color:var(--primary)}
  .loader.show{display:flex}
  .loader-spinner{width:48px;height:48px;border:5px solid #f3f3f3;border-top:5px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .emoji-picker{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:10px 0}
  .emoji-choice{font-size:40px;text-align:center;padding:10px;border-radius:12px;cursor:pointer;border:2px solid transparent}
  .emoji-choice.selected{border-color:var(--primary);background:rgba(79,70,229,.1)}
  #reportBox h4{margin:16px 0 8px 0;border-bottom:1px solid #eee;padding-bottom:4px}
  #reportBox ul{padding-left:20px;margin:0;line-height:1.6} #reportBox li{margin-bottom:8px}
  label{font-weight:bold;font-size:14px;margin-top:10px;margin-bottom:4px;display:block;}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:#fff}
</style>
</head>
<body>
<div id="loader" class="loader"><div class="loader-spinner"></div><div id="loader-msg"></div></div>
<div class="wrap">
  <div class="topbar card no-print">
    <div class="brand">
      <div style="font-size:32px">📈</div>
      <div><div class="title">감정 데이터 입력 (학급)</div><div class="muted" style="font-size:12px">v7.4 · Admin Default in Dropdown</div></div>
    </div>
    <div class="iconbtn-group">
      <button id="manualSync" class="iconbtn">🔄<span class="label">새로고침</span></button>
      <button id="openSheet" class="iconbtn admin-only">📄<span class="label">시트보기</span></button>
      <button id="gear" class="iconbtn admin-only">⚙️<span class="label">설정</span></button>
    </div>
  </div>

  <!-- 로그인 -->
  <section id="login" class="card">
    <div class="row" style="justify-content:space-between;align-items:center"><h2>🔐 로그인</h2></div>
    <div class="row">
      <select id="userSelect"><option value="admin">admin</option></select>
      <input id="password" type="password" placeholder="비밀번호"/>
      <button id="btnLogin" class="btn primary">로그인</button>
    </div>
    <div class="muted" style="margin-top:6px">연결: <span id="linkStatus" class="pill">미설정</span></div>
  </section>

  <!-- 앱 -->
  <section id="app" class="card hide">
    <div class="row no-print" style="justify-content:space-between;align-items:center;margin-bottom:12px">
      <div id="who" class="pill">-</div>
      <button id="btnLogout" class="btn">로그아웃</button>
    </div>

    <div class="tabs no-print" id="tabs">
      <button class="tab active" data-tab="am">🏫 등교</button>
      <button class="tab" data-tab="pm">🏡 하교</button>
      <button class="tab student-only" data-tab="graph">📊 나의 그래프</button>
      <button class="tab admin-only" data-tab="data">📋 데이터 관리</button>
      <button class="tab admin-only" data-tab="graph">📊 보고서</button>
      <button class="tab admin-only" data-tab="list">👥 학생목록</button>
      <button class="tab admin-only" data-tab="new">➕ 학생등록</button>
      <button class="tab admin-only" data-tab="users">🔑 사용자 관리</button>
    </div>

    <!-- AM -->
    <div id="tab-am">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="amPrev">◀</button>
        <button class="pill" id="amDateBtn"><span id="amDate"></span></button>
        <input id="amDatePicker" class="hide" type="date"/>
        <button class="btn" id="amNext">▶</button>
      </div>
      <h3 class="admin-only" style="display:block;">학생 선택</h3>
      <div id="amScroller" class="scroller admin-only" style="display:flex;"></div>
      <div id="amForm">
        <h3 id="amWho" style="text-align:center;margin-top:16px"></h3>
        <div id="amEmotions"></div>
        <div id="amCtxWrap" class="hide">
          <div style="text-align:center;margin:12px 0 8px" class="muted">어떤 상황이었나요? (복수선택 가능)</div>
          <div id="amCtx" class="context"></div>
        </div>
        <div class="row" style="margin-top:16px;justify-content:center">
          <button class="btn primary" id="amSave" style="padding:12px 32px">저장하기</button>
        </div>
      </div>
    </div>

    <!-- PM -->
    <div id="tab-pm" class="hide">
      <div class="row" style="justify-content:center;gap:8px">
        <button class="btn" id="pmPrev">◀</button>
        <button class="pill" id="pmDateBtn"><span id="pmDate"></span></button>
        <input id="pmDatePicker" class="hide" type="date"/>
        <button class="btn" id="pmNext">▶</button>
      </div>
      <h3 class="admin-only" style="display:block;">학생 선택</h3>
      <div id="pmScroller" class="scroller admin-only" style="display:flex;"></div>
      <div id="pmForm">
        <h3 id="pmWho" style="text-align:center;margin-top:16px"></h3>
        <div id="pmEmotions"></div>
        <div id="pmCtxWrap" class="hide">
          <div style="text-align:center;margin:12px 0 8px" class="muted">어떤 상황이었나요? (복수선택 가능)</div>
          <div id="pmCtx" class="context"></div>
        </div>
        <div class="row" style="margin-top:16px;justify-content:center">
          <button class="btn primary" id="pmSave" style="padding:12px 32px">저장하기</button>
        </div>
      </div>
    </div>

    <!-- 데이터 관리 -->
    <div id="tab-data" class="hide admin-only">
      <div class="row">
        <select id="dataStudentSelect"></select>
        <select id="dataSlotSelect">
          <option value="">전체</option>
          <option value="morning">등교</option>
          <option value="afternoon">하교</option>
        </select>
        <button id="btnClear" class="btn ghost">초기화</button>
      </div>
      <table>
        <thead><tr><th>날짜</th><th>학생</th><th>구분</th><th>점수</th><th>맥락</th><th>관리</th></tr></thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>

    <!-- 그래프/보고서 -->
    <div id="tab-graph" class="hide">
      <div class="row admin-only"><select id="graphStudent"></select></div>
      <div class="row">
        <input type="date" id="fromDate"><input type="date" id="toDate">
        <button class="btn" id="btnGraph">생성</button>
        <button class="btn admin-only" id="btnPrint">🖨️ 인쇄</button>
      </div>
      <h3 id="graphTitle" style="text-align:center; margin-top:16px; min-height: 24px;"></h3>
      <div class="chart-container"><canvas id="chart"></canvas></div>
      <div id="reportBox" class="card admin-only" style="margin-top:16px"></div>
    </div>

    <!-- 학생 목록 -->
    <div id="tab-list" class="hide admin-only"><h3>학생 목록</h3><div id="stuList"></div></div>

    <!-- 학생 등록 -->
    <div id="tab-new" class="hide admin-only">
      <h3>학생 등록</h3>
      <div class="row"><input id="newName" placeholder="학생 이름"><div id="newAvatar" class="avatar">👤</div></div>
      <div class="emoji-picker" id="newEmojiPicker"></div>
      <label for="photo" class="btn" style="width:100%;text-align:center">또는 사진 업로드</label>
      <input id="photo" type="file" accept="image/*" class="hide"><div style="height:8px"></div>
      <label>로그인 아이디</label><input id="newUsername" placeholder="학생 로그인 시 사용할 아이디"/>
      <label>초기 비밀번호</label><input id="newPassword" placeholder="학생 로그인 시 사용할 비밀번호"/>
      <label>학급</label><div id="chipsClass" class="context"></div>
      <label>성별</label><div id="chipsSex" class="context"></div>
      <label>진단</label><div id="chipsDx" class="context"></div>
      <label>의사소통</label><div id="chipsComm" class="context"></div>
      <label>감각 프로필</label><div id="chipsSensory" class="context"></div>
      <label>선호 강화제</label><div id="chipsReinf" class="context"></div>
      <label>주요 유발상황</label><div id="chipsTrigger" class="context"></div>
      <label>의료/약물</label><div id="chipsMeds" class="context"></div>
      <div class="row" style="margin-top:8px"><input id="newParent" type="tel" placeholder="보호자 연락처"/></div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn primary" id="addStu">등록</button></div>
    </div>

    <!-- 사용자 관리 -->
    <div id="tab-users" class="hide admin-only">
      <h3>사용자 관리</h3>
      <table><thead><tr><th>아이디</th><th>역할</th><th>새 비밀번호</th><th>저장</th></tr></thead><tbody id="userBody"></tbody></table>
    </div>
  </section>
</div>

<!-- 설정 모달 -->
<div id="modalSettings" class="modal">
  <div class="box">
    <h3>연동 설정</h3>
    <p class="muted">배포된 웹앱 URL을 붙여넣고 저장하세요.</p>
    <input id="syncUrlInput" placeholder="https://script.google.com/macros/s/...">
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="saveUrl" class="btn primary">저장</button>
      <button class="btn" onclick="closeModal('#modalSettings')">닫기</button>
    </div>
  </div>
</div>

<!-- 완료 모달 -->
<div id="modalDone" class="modal">
  <div class="box"><h3>✅ 완료</h3><div id="doneMsg"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="doneOk" class="btn primary">확인</button>
    </div>
  </div>
</div>

<!-- 학생 수정 모달 -->
<div id="modalEdit" class="modal">
  <div class="box">
    <h3>학생 정보 수정</h3>
    <div class="row"><input id="editName" placeholder="이름"><div id="editAvatar" class="avatar">👤</div></div>
    <div class="emoji-picker" id="editEmojiPicker"></div>
    <label for="editPhoto" class="btn" style="width:100%;text-align:center">또는 사진 업로드</label>
    <input id="editPhoto" type="file" accept="image/*" class="hide"><div style="height:8px"></div>
    <label>학급</label><div id="editClass" class="context"></div>
    <label>성별</label><div id="editSex" class="context"></div>
    <label>진단</label><div id="editDx" class="context"></div>
    <label>의사소통</label><div id="editComm" class="context"></div>
    <label>감각 프로필</label><div id="editSensory" class="context"></div>
    <label>선호 강화제</label><div id="editReinf" class="context"></div>
    <label>주요 유발상황</label><div id="editTrigger" class="context"></div>
    <label>의료/약물</label><div id="editMeds" class="context"></div>
    <div class="row" style="margin-top:8px"><input id="editParent" type="tel" placeholder="보호자 연락처"/></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn primary" id="editSave">저장</button>
      <button class="btn" onclick="closeModal('#modalEdit')">닫기</button>
    </div>
  </div>
</div>

<!-- 기록 수정 모달 -->
<div id="modalEditEmotion" class="modal">
  <div class="box">
    <h3>기록 수정</h3>
    <p id="editEmotionInfo" class="muted"></p>
    <label>감정 점수 (0-5)</label><input id="editEmotionScore" type="number" min="0" max="5" />
    <label style="margin-top:8px">맥락 (쉼표로 구분)</label><input id="editEmotionContext" type="text" placeholder="예: 수면부족, 또래갈등"/>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="editEmotionSave" class="btn primary">저장</button>
      <button class="btn" onclick="closeModal('#modalEditEmotion')">닫기</button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const KEY_URL="sync_url_classroom_v7";
  let SYNC_URL=localStorage.getItem(KEY_URL)||"";

  // 세션 상태
  let session={role:null,user:null},students=[],emotionData={};
  let editTargetId=null, editEmotionTarget=null;
  let chartInstance = null;

  const PROFILE_EMOJIS = ['🐯', '🐰', '🐼', '🦊', '🐨', '🐵', '🦄', '🦖'];
  const EMO={5:{e:"😊",n:"행복해요",d:"웃음, 눈 반짝임, 손뼉치기 등"},4:{e:"🙂",n:"좋아요",d:"편안한 얼굴, 활동에 적극적 참여"},3:{e:"😐",n:"괜찮아요",d:"표정 변화 적음, 지시에 반응"},2:{e:"😕",n:"불편해요",d:"눈썹 찌푸림, 꼼지락거림, 거부 시작"},1:{e:"😟",n:"힘들어요",d:"울상, 눈물, 몸 움츠림, 소리 지름"},0:{e:"😫",n:"괴로워요",d:"울음/고함, 바닥 눕기, 자해 시도"}};
  const CTX=[["😴 수면부족"],["💊 건강저하"],["🏠 가정이슈"],["🔄 활동전환"],["🧒 또래갈등"],["👀 관심요구"],["🎁 강화제요구"],["🚪 과제회피"],["🌀 감각추구"],["🔊 소음민감"],["🍽️ 배고픔"],["🤕 통증/불편"],["📅 일정변경"],["🚌 등하교피로"],["🌤️ 날씨영향"]];
  const OPS={
    classes:["A","B","C","D","E","F","G"],sex:["남","여"],dx:["지적장애","자폐스펙트럼","ADHD","학습장애","정서·행동장애","기타"],comm:["구어","PECS","AAC","제스처","제한적 언어","기타"],
    sensory:["청각 과민","시각 과민","촉각 과민","압박 선호","움직임 추구","기타"],reinf:["스티커","음식","활동","전자기기","사회적 칭찬","기타"],
    trigger:["과제 전환","소음","일정 변경","또래 갈등","요구 거부","기타"],meds:["없음","항정신병제","항불안제","항경련제","기타"]
  };

  const $=s=>document.querySelector(s),$$=s=>[...document.querySelectorAll(s)];
  const fmt=d=>new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().split("T")[0];
  const dateK=d=>d.toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});
  function showLoader(msg){$("#loader-msg").textContent=msg||"처리 중...";$("#loader").classList.add("show");}
  function hideLoader(){$("#loader").classList.remove("show");}
  function openModal(id){$(id).classList.add("show");} function closeModal(id){$(id).classList.remove("show");}
  function done(msg){$("#doneMsg").textContent=msg||"완료되었습니다.";openModal("#modalDone");}

  // ---- API 래퍼
  async function api(action,params={}){
    if(!SYNC_URL)throw new Error("웹앱 URL 미설정");
    const u=new URL(SYNC_URL);
    u.searchParams.set('action',action);
    for(const k in params){ if(params[k]!==undefined && params[k]!==null && params[k]!=="") u.searchParams.set(k,params[k]); }
    const r=await fetch(u);
    const j=await r.json();
    if(!r.ok||j.error)throw new Error(j?.error||(\`서버 통신 오류: \${r.status}\`));
    return j;
  }
  async function postApi(body){
    if(!SYNC_URL)throw new Error("웹앱 URL 미설정");
    const r=await fetch(SYNC_URL,{method:"POST",body:JSON.stringify(body)});
    const j=await r.json();
    if(!r.ok||j.error)throw new Error(j?.error||(\`서버 통신 오류: \${r.status}\`));
    return j;
  }
  function setSyncUrl(url){
    SYNC_URL=url.trim();
    localStorage.setItem(KEY_URL,SYNC_URL);
    $("#linkStatus").textContent=SYNC_URL?"설정됨":"미설정";
    if(SYNC_URL)initLoginScreen();
  }

  // ---- Chips/Picker
  function chipContainer(el,ops,single=false){const c=$(el);if(!c)return;c.innerHTML=ops.map(v=>\`<div class="chip" data-v="\${v}">\${v}</div>\`).join("");c.onclick=e=>{const t=e.target.closest(".chip");if(!t)return;if(single){c.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected"));t.classList.add("selected");}else t.classList.toggle("selected");};}
  function getChips(el){return $$\`\${el} .chip.selected\`.map(x=>x.dataset.v);}
  function setChips(el,vals=[],ops,single=false){const c=$(el);if(!c)return;c.innerHTML=ops.map(v=>\`<div class="chip \${(vals||[]).includes(v)?'selected':''}" data-v="\${v}">\${v}</div>\`).join("");c.onclick=e=>{const t=e.target.closest(".chip");if(!t)return;if(single){c.querySelectorAll(".chip").forEach(x=>x.classList.remove("selected"));t.classList.add("selected");}else t.classList.toggle("selected");};}
  function createEmojiPicker(containerId, avatarId){const p=$(\`#\${containerId}\`);const a=$(\`#\${avatarId}\`);if(!p||!a)return;p.innerHTML=PROFILE_EMOJIS.map(em=>\`<div class="emoji-choice" data-emoji="\${em}">\${em}</div>\`).join('');p.onclick=e=>{const t=e.target.closest('.emoji-choice');if(!t)return;p.querySelectorAll('.emoji-choice').forEach(c=>c.classList.remove('selected'));t.classList.add('selected');a.textContent=t.dataset.emoji;a.style.backgroundImage='';a.dataset.selected=t.dataset.emoji;};}

  // ---- 학생/감정 렌더
  function renderStudents(containerSel){const c=$(containerSel);if(!c)return;const l=session.role==="admin"?students:[session.user];c.innerHTML=l.map(s=>\`<div class="stu" data-id="\${s.id}"><div class="avatar" style="\${(s.photo||'').startsWith('data:image')?\`background-image:url(\${s.photo})\`:''}">\${(s.photo||'').startsWith('data:image')?'':s.photo||'👤'}</div><div style="font-weight:800;margin-top:6px">\${s.name}</div></div>\`).join("")||\`<div class="muted">학생 없음</div>\`;c.onclick=e=>{const card=e.target.closest(".stu");if(!card)return;c.querySelectorAll(".stu").forEach(x=>x.classList.remove("selected"));card.classList.add("selected");const s=students.find(x=>x.id==card.dataset.id);if(!s)return;const p=containerSel.includes("am")?"am":"pm";$(\`#\${p}Form\`).classList.remove("hide");$(\`#\${p}Who\`).textContent=\`\${s.name} 학생 감정기록\`;c.dataset.sel=card.dataset.id;};}
  function renderEmo(prefix, isStudent){const b=$(\`#\${prefix}Emotions\`);b.innerHTML=Object.keys(EMO).sort((a,b)=>b-a).map(sc=>\`<div class="emoBtn" data-score="\${sc}"><div style="font-size:28px">\${EMO[sc].e}</div><div><div style="font-weight:800">\${sc}점 · \${EMO[sc].n}</div>\${isStudent?'':\`<div class="muted" style="font-size:12px">\${EMO[sc].d}</div>\`}</div></div>\`).join("");b.onclick=e=>{const btn=e.target.closest(".emoBtn");if(!btn)return;b.querySelectorAll(".emoBtn").forEach(x=>x.classList.remove("active"));btn.classList.add("active");b.dataset.score=btn.dataset.score;$(\`#\${prefix}CtxWrap\`).classList.remove("hide");};}
  function renderCtx(prefix){const el=$(\`#\${prefix}Ctx\`);el.innerHTML=CTX.map(([t])=>\`<div class="chip" data-k="\${t}">\${t}</div>\`).join("");el.onclick=e=>{const c=e.target.closest(".chip");if(!c)return;c.classList.toggle("selected");};}

  // ---- Admin 현황(완료 표시/자동 익일 이동)
  async function updateStudentCardStatus(prefix, date) {
    if(session.role !== 'admin') return false;
    try{
      const dateStr=fmt(date);
      const params = { from: dateStr, to: dateStr };
      const dayData=(await api('get_emotions', params)).emotion[dateStr]||{};
      const scroller=$(\`#\${prefix}Scroller\`);const studentCards=scroller.querySelectorAll('.stu');
      if(studentCards.length===0)return false;let allCompleted=true;
      studentCards.forEach(card=>{const studentId=card.dataset.id;const slot=prefix==='am'?'morning':'afternoon';if(dayData[studentId]&&dayData[studentId][slot]){card.classList.add('completed');}else{card.classList.remove('completed');allCompleted=false;}});
      return allCompleted;
    }catch(e){console.warn("현황 조회 실패(연결 미설정 가능):",e.message);return false;}
  }

  async function handleSaveEmotion(prefix, btn){
    btn.disabled=true;showLoader("저장 중...");
    try{
      let sid;
      if(session.role === 'student'){ sid = session.user.id; }
      else { sid = $(\`#\${prefix}Scroller\`).dataset.sel; }
      const box=$(\`#\${prefix}Emotions\`),score=box.dataset.score;
      if(!sid||score===undefined)throw new Error("학생과 감정을 선택하세요.");
      const date=prefix==="am"?amDate:pmDate;
      const ctxSel=$$\(\`#\${prefix}Ctx .chip.selected\`\).map(x=>x.dataset.k);

      // 서버 연동시
      if(SYNC_URL){
        await postApi({action:"add_emotion",date:fmt(date),student_id:sid,slot:(prefix==="am"?"morning":"afternoon"),score:Number(score),context:ctxSel});
      }else{
        console.warn("연결 미설정: 로컬 모드(미저장)");
        done("연결이 설정되지 않아 실제 저장은 되지 않았습니다. ⚙️에서 URL을 설정하세요.");
      }

      done("처리가 완료되었습니다.");
      box.querySelector('.active')?.classList.remove('active');box.dataset.score='';$(\`#\${prefix}CtxWrap\`).classList.add("hide");$$\(\`#\${prefix}Ctx .chip\`\).forEach(x=>x.classList.remove("selected"));
      if(session.role === 'admin') {
          const scroller = $(\`#\${prefix}Scroller\`);
          scroller.querySelector('.selected')?.classList.remove('selected');
          $(\`#\${prefix}Form\`).classList.add('hide');
          const allDone = await updateStudentCardStatus(prefix, date);
          if (allDone) {
              done("모든 학생 입력 완료! 다음 날로 이동합니다.");
              date.setDate(date.getDate() + 1);
              await setDates();
          }
      }
    }catch(e){done(\`저장 실패: \${e.message}\`);}finally{btn.disabled=false;hideLoader();}
  }

  let amDate=new Date(),pmDate=new Date();
  async function setDates(){$("#amDate").textContent=dateK(amDate);$("#pmDate").textContent=dateK(pmDate);$("#amDatePicker").value=fmt(amDate);$("#pmDatePicker").value=fmt(pmDate);if(session.role==='admin'){showLoader("입력상태 확인중...");try{await Promise.all([updateStudentCardStatus('am',amDate),updateStudentCardStatus('pm',pmDate)]);}catch(e){console.error("Status update failed:",e)}finally{hideLoader();}}}

  async function onTabClick(tabId){
    $$(".tab").forEach(t=>t.classList.remove("active"));
    $$("[id^='tab-']").forEach(p=>p.classList.add("hide"));
    $(`.tab[data-tab="${tabId}"]`).classList.add("active");
    $(`#tab-${tabId}`).classList.remove("hide");

    showLoader("데이터 로딩 중...");
    try{
      if(session.role==='admin'){
        await fetchStudents();
        if(tabId==="list"){renderStudentList();}
        else if(tabId==="data"){await fetchAndRenderEmotions();}
        else if(tabId==="graph"){renderGraphStudentSelect();} 
        else if(tabId==="users"){await renderUserManagement();}
      }
    }catch(e){console.warn("탭 로딩 중 연결 오류:",e.message);}
    finally{hideLoader();}
  }

  async function fetchStudents(){
    if(!SYNC_URL){
      students=[
        {id:"1",name:"샘플A",photo:"👤",classes:["A"],sex:"남",dx:["지적장애"],comm:["구어"]},
        {id:"2",name:"샘플B",photo:"👤",classes:["A"],sex:"여",dx:["자폐스펙트럼"],comm:["PECS"]},
        {id:"3",name:"샘플C",photo:"👤",classes:["B"],sex:"남",dx:["지적장애","ADHD"],comm:["제스처"]},
      ];
      renderStudents("#amScroller");renderStudents("#pmScroller");return;
    }
    students=(await api('get_students')).students||[];
    if(session.role==='admin'){renderStudents("#amScroller");renderStudents("#pmScroller");}
  }

  async function fetchAndRenderEmotions(){
    if(!SYNC_URL){ emotionData={};renderDataManager();renderDataStudentSelect();return; }
    emotionData=(await api('get_emotions')).emotion||{};renderDataManager();renderDataStudentSelect();
  }

  function renderStudentList(){const l=students;$("#stuList").innerHTML=l.map(s=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid #e5e7eb;padding:8px 0"><div class="row"><div class="avatar" style="${(s.photo||'').startsWith('data:image')?`background-image:url(${s.photo})`:''}">${(s.photo||'').startsWith('data:image')?'':s.photo||'👤'}</div><div><div><b>${s.name}</b> <span class="muted">(${(s.classes||[]).join(", ")})</span></div><div class="muted" style="font-size:12px">${(s.dx||[]).join('/')}·${(s.comm||[]).join('/')}</div></div></div><div class="row"><button class="btn" data-edit="${s.id}">수정</button><button class="btn danger" data-del="${s.id}">삭제</button></div></div>`).join("")||`<div class="muted">학생 없음</div>`;}
  function renderDataStudentSelect(){const s=$('#dataStudentSelect');const l=students;s.innerHTML=`<option value="">학생 전체</option>`+l.map(st=>`<option value="${st.name}">${st.name}</option>`).join('');}
  function renderDataManager(nameFilter="",slotFilter=""){const b=$("#dataBody");b.innerHTML="";const dates=Object.keys(emotionData).sort((a,b)=>b.localeCompare(a));dates.forEach(k=>{const day=emotionData[k];Object.keys(day).forEach(sid=>{const rec=day[sid],nm=rec.name||"";if(nameFilter&&nm!==nameFilter)return;['morning','afternoon'].forEach(slot=>{if(slotFilter&&slot!==slotFilter)return;const cur=rec[slot];if(!cur)return;const tr=document.createElement("tr");tr.innerHTML=`<td>${k}</td><td>${nm}</td><td>${slot==="morning"?"등교":"하교"}</td><td>${cur.score}</td><td>${(cur.context||[]).join(", ")}</td><td><div class="row" style="justify-content:center"><button class="btn" data-edit="true">수정</button><button class="btn danger" data-del="true">삭제</button></div></td>`;tr.dataset.date=k;tr.dataset.sid=sid;tr.dataset.slot=slot;tr.dataset.score=cur.score;tr.dataset.context=(cur.context||[]).join(',');b.appendChild(tr);});});});}
  function renderGraphStudentSelect(){const s=$("#graphStudent");const l=students;s.innerHTML=`<option value="">학생 선택</option>`+l.map(st=>`<option value="${st.id}">${st.name}</option>`).join("");}

  async function handleGraph(){const from=$("#fromDate").value,to=$("#toDate").value;if(!from||!to)return done("기간을 선택하세요.");let sid,studentName;if(session.role==='student'){sid=session.user.id;studentName=session.user.name;}else{sid=$("#graphStudent").value;if(!sid)return done("학생을 선택하세요.");studentName=students.find(s=>s.id==sid)?.name;}const btn=$("#btnGraph");btn.disabled=true;showLoader("보고서 생성 중...");const graphTitleEl=$("#graphTitle");try{if(!studentName)throw new Error("학생 정보를 찾을 수 없습니다.");if(graphTitleEl)graphTitleEl.textContent=`${studentName} 학생 감정 모니터링`;let periodEmotion={emotion:{}};if(SYNC_URL){periodEmotion=await api('get_emotions',{from,to,studentId:sid});}const g=getRangeData(sid,from,to,periodEmotion.emotion);drawChart("chart",g.labels,g.am,g.pm);if(session.role==='admin')genReport(students.find(s=>s.id==sid)||{id:sid,name:studentName},from,to,periodEmotion.emotion);}catch(e){done(`그래프 생성 실패: ${e.message}`);if(graphTitleEl)graphTitleEl.textContent='';if(chartInstance){chartInstance.destroy();chartInstance=null;}}finally{btn.disabled=false;hideLoader();}}
  function getRangeData(sid,from,to,emoData){const labels=[],am=[],pm=[];const cur=new Date(from);const end=new Date(to);while(cur<=end){const k=fmt(cur),r=emoData?.[k]?.[sid];labels.push(k.slice(5));am.push(r?.morning?.score??null);pm.push(r?.afternoon?.score??null);cur.setDate(cur.getDate()+1);}return{labels,am,pm};}

  function drawChart(canvasId,labels,am,pm){const ctx=$(`#${canvasId}`).getContext('2d');if(chartInstance)chartInstance.destroy();Chart.register(ChartDataLabels);chartInstance=new Chart(ctx,{type:'line',data:{labels:labels,datasets:[{label:'등교',data:am,borderColor:'#ef4444',backgroundColor:'#ef4444',pointStyle:'circle',radius:5,tension:0.1},{label:'하교',data:pm,borderColor:'#2563eb',backgroundColor:'#2563eb',pointStyle:'triangle',radius:6,tension:0.1}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{min:0,max:5,ticks:{stepSize:1}}},plugins:{datalabels:{align:'top',color:'black',font:{weight:'bold'},formatter:v=>v}}}});}

  function genReport(s,from,to,emoData){const box=$("#reportBox");if(!s){box.innerHTML="학생 정보 없음";return;}const recs=[];const cur=new Date(from),end=new Date(to);while(cur<=end){const k=fmt(cur);const r=emoData[k]?.[s.id];if(r?.morning)recs.push({score:r.morning.score,ctx:r.morning.context||[]});if(r?.afternoon)recs.push({score:r.afternoon.score,ctx:r.afternoon.context||[]});cur.setDate(cur.getDate()+1);}if(recs.length===0){box.innerHTML=`<div class="muted">선택된 기간에 데이터가 없습니다.</div>`;return;}const lowRecs=recs.filter(r=>r.score<=1);const ctxCount={};lowRecs.forEach(r=>r.ctx.forEach(c=>ctxCount[c]=(ctxCount[c]||0)+1));const topCtx=Object.entries(ctxCount).sort((a,b)=>b[1]-a[1]).slice(0,3);const topCtxKey=topCtx[0]?.[0]||"특정 맥락";let html=`<h4>전문가 소견</h4><ul>`;const perspectives={behavioral:`<b>[행동분석 관점]</b> 학생의 감정적 어려움(0-1점)은 <strong>'${topCtxKey}'</strong> 상황에서 주로 관찰되며, ABC 관찰을 통해 기능 가설을 확인합니다.`,sensory:`<b>[감각 관점]</b> <strong>'${topCtx.find(([k])=>k.includes('감각')||k.includes('소음'))?.[0]||'외부 자극'}'</strong> 관련 맥락이 잦다면 감각 과부하/결핍을 의심하고 환경 조절을 우선합니다.`,cognitive:`<b>[인지행동 관점]</b> 위협적 해석 경향이 있다면 감정 인식·표현 훈련(CBT/DBT 기법)을 병행합니다.`};html+=`<li>${perspectives.behavioral}</li><li>${perspectives.sensory}</li><li>${perspectives.cognitive}</li></ul>`;html+=`<h4>중재 계획 제안</h4>`;const plans={setting:"<b>배경사건:</b> 수면·식사·일정 예고 등 컨디션 안정 루틴 확립",antecedent:"<b>선행사건:</b> 전환 예고, 과제 난이도 조절, 선택권 제공",skill:"<b>대체기술:</b> FCT로 '도와주세요' 등 기능적 의사소통 지도",reinforce:"<b>강화:</b> 긍정적 감정표현/참여에 즉시 강화(토큰경제)",crisis:"<b>위기:</b> 안전 우선·안정 공간·사후 복귀 절차"};html+=`<ul>${Object.values(plans).map(p=>`<li>${p}</li>`).join('')}</ul>`;box.innerHTML=html;}

  async function imgToDataURL(file){return new Promise(res=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.readAsDataURL(file);});}

  // ---- 로그인 화면 초기 사용자 목록
  async function initLoginScreen(){
    const userSelect = $('#userSelect');
    // 1) 항상 admin을 최상단 옵션으로 보장
    userSelect.innerHTML = '<option value="admin">admin</option>';

    if(!SYNC_URL){ return; }
    showLoader("사용자 목록 로딩 중...");
    try{
      const { users } = await api('get_users');
      // 2) 서버 사용자들을 admin 중복 없이 추가
      const options = users
        .map(u => u.username)
        .filter(u => u && u !== 'admin')
        .map(u => `<option value="${u}">${u}</option>`)
        .join('');
      userSelect.insertAdjacentHTML('beforeend', options);
    }catch(e){
      console.warn("사용자 목록 로딩 실패:", e.message);
    }finally{ hideLoader(); }
  }

  function setupAdminUI(){$("body").className='role-admin';$("#who").textContent=session.user.name||'관리자';fetchStudents();setDates();renderEmo("am",false);renderEmo("pm",false);renderCtx("am");renderCtx("pm");Object.keys(OPS).forEach(key=>{const elId=`#chips${key.charAt(0).toUpperCase()+key.slice(1)}`;chipContainer(elId,OPS[key],key==='sex');});createEmojiPicker('newEmojiPicker','newAvatar');createEmojiPicker('editEmojiPicker','editAvatar');}
  function setupStudentUI(){$("body").className='role-student';$("#who").textContent=session.user.name;$("#amWho").textContent=`${session.user.name} 학생 감정기록`;$("#pmWho").textContent=`${session.user.name} 학생 감정기록`;$("#amForm").classList.remove('hide');$("#pmForm").classList.add('hide');$(".tabs .tab[data-tab='am']").classList.add('active');$(".tabs .tab[data-tab='pm']").classList.remove('active');setDates();renderEmo("am",true);renderEmo("pm",true);renderCtx("am");renderCtx("pm");}

  async function renderUserManagement(){
    if(!SYNC_URL){ $('#userBody').innerHTML='<tr><td colspan="4">⚠️ 연결이 설정되면 사용자 목록을 불러옵니다.</td></tr>'; return; }
    const{users}=await api('get_users');
    const body=$('#userBody');body.innerHTML=users.map(u=>`<tr><td>${u.username}</td><td>${u.role}</td><td><input type="password" class="pw-input" data-username="${u.username}" placeholder="새 비밀번호"></td><td><button class="btn primary save-pw-btn" data-username="${u.username}">저장</button></td></tr>`).join('');
  }
  $('#userBody').onclick=async e=>{if(e.target.classList.contains('save-pw-btn')){const btn=e.target;const username=btn.dataset.username;const newPassword=$(`.pw-input[data-username="${username}"]`).value;if(!newPassword)return done('새 비밀번호를 입력하세요.');showLoader('비밀번호 변경 중...');try{if(!SYNC_URL)throw new Error("연결 미설정");await postApi({action:'update_password',username,newPassword});done(`${username}의 비밀번호가 변경되었습니다.`);$(`.pw-input[data-username="${username}"]`).value='';}catch(err){done(`변경 실패: ${err.message}`);}finally{hideLoader();}}};

  // ---- 상단 버튼
  $("#gear").onclick=()=>openModal("#modalSettings");$("#doneOk").onclick=()=>closeModal("#modalDone");
  $("#saveUrl").onclick=()=>{setSyncUrl($("#syncUrlInput").value);done("URL이 저장되었습니다.");closeModal("#modalSettings");};
  $$(".tab").forEach(t=>t.onclick=()=>onTabClick(t.dataset.tab));

  // ---- 로그인 버튼 (로컬 admin 부트스트랩 + 서버 로그인)
  $("#btnLogin").onclick=async()=>{
    const username=$("#userSelect").value||"admin";
    const password=$("#password").value;
    const btn=$("#btnLogin");
    btn.disabled=true;showLoader("로그인 중...");

    // 1) 프런트 오프라인 admin 패스
    if(username==="admin" && password==="admin1234"){
      session = { ok:true, role:'admin', user:{ id:'admin', name:'관리자' } };
      $("#login").classList.add("hide");$("#app").classList.remove("hide");
      setupAdminUI(); hideLoader(); return;
    }

    // 2) 서버 로그인 시도
    try{
      const result=await postApi({action:'login',username,password});
      if(!result.ok)throw new Error(result.error);
      session=result;
      $("#login").classList.add("hide");$("#app").classList.remove("hide");
      if(session.role==='admin')setupAdminUI();else setupStudentUI();
    }catch(e){
      done(`로그인 실패: ${e.message}`);
    }finally{btn.disabled=false;hideLoader();}
  };

  $("#password").onkeydown=e=>{if(e.key==="Enter")$("#btnLogin").click();};
  $("#btnLogout").onclick=()=>location.reload();
  $("#openSheet").onclick=async()=>{try{if(!SYNC_URL)throw new Error("연결 미설정");const{sheetUrl}=await api('get_sheet_url');if(sheetUrl)window.open(sheetUrl,'_blank')}catch(e){done(`시트 열기 실패: ${e.message}`)}};

  // 날짜 초기값
  const past=new Date();past.setDate(past.getDate()-14);$("#fromDate").value=fmt(past);$("#toDate").value=fmt(new Date());

  // 저장 버튼
  $("#amSave").onclick=(e)=>handleSaveEmotion("am",e.target); $("#pmSave").onclick=(e)=>handleSaveEmotion("pm",e.target);
  $("#amPrev").onclick=async()=>{amDate.setDate(amDate.getDate()-1);await setDates();}; $("#amNext").onclick=async()=>{amDate.setDate(amDate.getDate()+1);await setDates();};
  $("#pmPrev").onclick=async()=>{pmDate.setDate(pmDate.getDate()-1);await setDates();}; $("#pmNext").onclick=async()=>{pmDate.setDate(pmDate.getDate()+1);await setDates();};
  $("#amDateBtn").onclick=()=>$("#amDatePicker").showPicker?.();$("#pmDateBtn").onclick=()=>$("#pmDatePicker").showPicker?.();
  $("#amDatePicker").onchange=async e=>{amDate=new Date(e.target.value);await setDates();};$("#pmDatePicker").onchange=async e=>{pmDate=new Date(e.target.value);await setDates();};

  // 학생 등록
  $("#addStu").onclick=async(e)=>{const btn=e.target;btn.disabled=true;showLoader("등록 중...");try{
    const name=$("#newName").value.trim();if(!name)throw new Error("이름을 입력하세요.");
    const username=$("#newUsername").value.trim();if(!username)throw new Error("로그인 아이디를 입력하세요.");
    const password=$("#newPassword").value.trim();if(!password)throw new Error("초기 비밀번호를 입력하세요.");
    let photo=$("#newAvatar").dataset.selected||'👤';const f=$("#photo").files[0];if(f)photo=await imgToDataURL(f);
    let classes=getChips("#chipsClass");
    const s={id:0,name,photo,classes,sex:getChips("#chipsSex")[0]||"",dx:getChips("#chipsDx"),comm:getChips("#chipsComm"),sensory:getChips("#chipsSensory"),reinf:getChips("#chipsReinf"),trigger:getChips("#chipsTrigger"),meds:getChips("#chipsMeds"),parent:$("#newParent").value.trim(),username,password};
    if(!SYNC_URL){ done("연결이 설정되면 실제 등록이 진행됩니다. 지금은 미리보기 상태입니다."); }
    else { await postApi({action:"add_student",student:s}); done("학생이 등록되었습니다."); await fetchStudents(); await initLoginScreen(); }
    $$("#tab-new .chip.selected").forEach(c=>c.classList.remove("selected"));
    $("#newName").value=$("#photo").value=$("#newParent").value=$("#newUsername").value=$("#newPassword").value="";$("#newAvatar").textContent="👤";$("#newAvatar").style.backgroundImage='';$("#newAvatar").dataset.selected="";
  }catch(err){done(`등록 실패: ${err.message}`);}finally{btn.disabled=false;hideLoader();}};
  $("#photo").onchange=async(e)=>{const f=e.target.files[0];if(!f)return;const dataUrl=await imgToDataURL(f);const avatar=$("#newAvatar");avatar.style.backgroundImage=`url(${dataUrl})`;avatar.textContent='';avatar.dataset.selected=dataUrl;$$('#newEmojiPicker .emoji-choice').forEach(c=>c.classList.remove('selected'))};

  // 학생 수정/삭제
  $("#stuList").onclick=async(e)=>{const editBtn=e.target.closest("[data-edit]"),delBtn=e.target.closest("[data-del]");if(editBtn){editTargetId=editBtn.dataset.edit;const s=students.find(x=>x.id==editTargetId);if(!s)return;$("#editName").value=s.name||"";const avatar=$("#editAvatar");if((s.photo||'').startsWith('data:image')){avatar.style.backgroundImage=`url(${s.photo})`;avatar.textContent=''}else{avatar.style.backgroundImage='';avatar.textContent=s.photo||'👤'}avatar.dataset.selected=s.photo;$("#editPhoto").value="";setChips("#editClass",s.classes,OPS.classes);setChips("#editSex",[s.sex],OPS.sex,true);setChips("#editDx",s.dx,OPS.dx);setChips("#editComm",s.comm);setChips("#editSensory",s.sensory,OPS.sensory);setChips("#editReinf",s.reinf,OPS.reinf);setChips("#editTrigger",s.trigger,OPS.trigger);setChips("#editMeds",s.meds,OPS.meds);$("#editParent").value=s.parent||"";openModal("#modalEdit");}if(delBtn){if(!confirm("학생과 해당 학생의 로그인 계정이 모두 삭제됩니다. 계속할까요?"))return;showLoader("삭제 중...");try{if(!SYNC_URL)throw new Error("연결 미설정");await postApi({action:"delete_student",id:delBtn.dataset.del});done("삭제되었습니다.");await fetchStudents();await initLoginScreen();await onTabClick("list");}catch(err){done(`삭제 실패: ${err.message}`);}finally{hideLoader();}}};
  $("#editSave").onclick=async(e)=>{const btn=e.target;btn.disabled=true;showLoader("수정 중...");try{const s=students.find(x=>x.id==editTargetId);if(!s)throw new Error("학생 정보 없음");s.name=$("#editName").value.trim();s.photo=$("#editAvatar").dataset.selected||s.photo;const pf=$("#editPhoto").files[0];if(pf)s.photo=await imgToDataURL(pf);s.classes=getChips("#editClass");s.sex=getChips("#editSex")[0]||"";s.dx=getChips("#editDx");s.comm=getChips("#editComm");s.sensory=getChips("#editSensory");s.reinf=getChips("#editReinf");s.trigger=getChips("#editTrigger");s.meds=getChips("#editMeds");s.parent=$("#editParent").value.trim();if(!SYNC_URL){ done("연결이 설정되면 실제 수정이 진행됩니다."); } else { await postApi({action:"update_student",student:s}); done("수정되었습니다."); await fetchStudents(); await onTabClick("list"); } closeModal("#modalEdit");}catch(err){done(`수정 실패: ${err.message}`);}finally{btn.disabled=false;hideLoader();}};
  $("#editPhoto").onchange=async(e)=>{const f=e.target.files[0];if(!f)return;const dataUrl=await imgToDataURL(f);const avatar=$("#editAvatar");avatar.style.backgroundImage=`url(${dataUrl})`;avatar.textContent='';avatar.dataset.selected=dataUrl;$$('#editEmojiPicker .emoji-choice').forEach(c=>c.classList.remove('selected'))};

  // 기록 수정/삭제
  $("#dataBody").onclick=async e=>{const delBtn=e.target.closest("[data-del]"),editBtn=e.target.closest("[data-edit]");if(delBtn){if(!confirm("이 기록을 삭제할까요?"))return;const tr=delBtn.closest("tr");showLoader("삭제 중...");try{if(!SYNC_URL)throw new Error("연결 미설정");await postApi({action:"delete_emotion",date:tr.dataset.date,student_id:tr.dataset.sid,slot:tr.dataset.slot});done("삭제되었습니다.");tr.remove();}catch(err){done(`삭제 실패: ${err.message}`);}finally{hideLoader();}}if(editBtn){const tr=editBtn.closest("tr");editEmotionTarget={date:tr.dataset.date,sid:tr.dataset.sid,slot:tr.dataset.slot};$("#editEmotionInfo").textContent=`${tr.children[0].textContent} / ${tr.children[1].textContent} / ${tr.children[2].textContent}`;$("#editEmotionScore").value=tr.dataset.score;$("#editEmotionContext").value=tr.dataset.context;openModal("#modalEditEmotion");}};
  $("#editEmotionSave").onclick=async e=>{const btn=e.target;btn.disabled=true;showLoader("수정 중...");try{const score=Number($("#editEmotionScore").value);const context=$("#editEmotionContext").value.split(',').map(s=>s.trim()).filter(Boolean);if(score<0||score>5)throw new Error("점수는 0에서 5 사이여야 합니다.");if(!SYNC_URL){ done("연결이 설정되면 실제 수정이 진행됩니다."); } else { await postApi({action:'update_emotion',date:editEmotionTarget.date,student_id:editEmotionTarget.sid,slot:editEmotionTarget.slot,score,context}); done("수정되었습니다."); await fetchAndRenderEmotions(); } closeModal("#modalEditEmotion");}catch(err){done(`수정 실패: ${err.message}`);}finally{btn.disabled=false;hideLoader();}};

  // 데이터 관리 필터
  $("#dataStudentSelect").onchange=e=>renderDataManager(e.target.value, $("#dataSlotSelect").value);
  $("#dataSlotSelect").onchange=e=>renderDataManager($("#dataStudentSelect").value, e.target.value);
  $("#btnClear").onclick=()=>{$("#dataStudentSelect").value="";$("#dataSlotSelect").value="";renderDataManager();};

  // 그래프/인쇄
  $("#btnGraph").onclick=handleGraph; $("#btnPrint").onclick=()=>window.print();
  $("#manualSync").onclick=async()=>{showLoader("동기화 중...");try{await fetchStudents();if(session.role !== 'student') await setDates();done("최신 정보로 동기화되었습니다.");}catch(e){done(`동기화 실패: ${e.message}`);}finally{hideLoader();}};

  // 초기화
  setSyncUrl(SYNC_URL);
  initLoginScreen();
});
</script>
</body>
</html>
